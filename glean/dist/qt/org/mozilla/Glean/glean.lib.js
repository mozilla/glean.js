var Glean;(()=>{var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{var i;e.r(t),e.d(t,{default:()=>Nn}),function(e){e.InvalidValue="invalid_value",e.InvalidLabel="invalid_label",e.InvalidState="invalid_state",e.InvalidOverflow="invalid_overflow",e.InvalidType="invalid_type"}(i||(i={}));function n(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}c((n=n.apply(e,t||[])).next())}))}Object.create;var r;Object.create;function s(e,t,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(e):n?n.value:t.get(e)}function a(e,t,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(e,i):r?r.value=i:t.set(e,i),i}function o(e,t,i=r.Debug){const n=`(Glean.${e})`;Array.isArray(t)?console[i](n,...t):console[i](n,t)}!function(e){e.Debug="debug",e.Info="info",e.Warn="warn",e.Error="error",e.Trace="trace"}(r||(r={}));const c={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let d;const u=new Uint8Array(16);function l(){if(!d&&(d="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!d))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return d(u)}const h=[];for(let e=0;e<256;++e)h.push((e+256).toString(16).slice(1));function f(e,t=0){return(h[e[t+0]]+h[e[t+1]]+h[e[t+2]]+h[e[t+3]]+"-"+h[e[t+4]]+h[e[t+5]]+"-"+h[e[t+6]]+h[e[t+7]]+"-"+h[e[t+8]]+h[e[t+9]]+"-"+h[e[t+10]]+h[e[t+11]]+h[e[t+12]]+h[e[t+13]]+h[e[t+14]]+h[e[t+15]]).toLowerCase()}const g=function(e,t,i){if(c.randomUUID&&!t&&!e)return c.randomUUID();const n=(e=e||{}).random||(e.rng||l)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=n[e];return t}return f(n)};var m,p;!function(e){e.Uninitialized="Uninitialized",e.Idle="Idle",e.Processing="Processing",e.Stopped="Stopped",e.Shutdown="Shutdown"}(m||(m={})),function(e){e.Task="Task",e.PersistentTask="PersistentTask",e.InitTask="InitTask",e.Stop="Stop",e.Clear="Clear",e.Shutdown="Shutdown",e.TestTask="TestTask"}(p||(p={}));const y=class{constructor(e=100,t="core.Dispatcher"){this.maxPreInitQueueSize=e,this.logTag=t,this.shuttingDown=!1,this.currentJob=Promise.resolve(),this.queue=[],this.state="Uninitialized"}getNextCommand(){return this.queue.shift()}executeTask(e){return n(this,void 0,void 0,(function*(){try{return yield e(),!0}catch(e){return o(this.logTag,"Error executing Glean task"+(e?`: ${e}`:". There might be more error logs above."),r.Error),!1}}))}unblockTestResolvers(){this.queue.forEach((e=>{"TestTask"===e.command&&e.resolver()}))}execute(){return n(this,void 0,void 0,(function*(){let e=this.getNextCommand();for(;e;){switch(e.command){case"Stop":return void(this.state="Stopped");case"Shutdown":return this.unblockTestResolvers(),this.queue=[],this.state="Shutdown",void(this.shuttingDown=!1);case"Clear":this.unblockTestResolvers(),this.queue=this.queue.filter((e=>["PersistentTask","Shutdown"].includes(e.command)));break;case"TestTask":yield this.executeTask(e.task),e.resolver();break;case"InitTask":(yield this.executeTask(e.task))||(o(this.logTag,["Error initializing dispatcher, won't execute anything further.","There might be more error logs above."],r.Error),this.clear(),this.shutdown());break;case"PersistentTask":case"Task":yield this.executeTask(e.task)}e=this.getNextCommand()}}))}triggerExecution(){"Idle"===this.state&&this.queue.length>0&&(this.state="Processing",this.currentJob=this.execute(),this.currentJob.then((()=>{const e=this;"Processing"===this.state&&(e.state="Idle")})).catch((e=>{o(this.logTag,["IMPOSSIBLE: Something went wrong while the dispatcher was executing the tasks queue.",e],r.Error)})))}launchInternal(e,t=!1){return"Shutdown"===this.state?(o(this.logTag,"Attempted to enqueue a new task but the dispatcher is shutdown. Ignoring.",r.Warn),!1):!t&&"Uninitialized"===this.state&&this.queue.length>=this.maxPreInitQueueSize?(o(this.logTag,"Unable to enqueue task, pre init queue is full.",r.Warn),!1):(t?this.queue.unshift(e):this.queue.push(e),this.triggerExecution(),!0)}launch(e){this.launchInternal({task:e,command:"Task"})}launchPersistent(e){this.launchInternal({task:e,command:"PersistentTask"})}flushInit(e){"Uninitialized"===this.state?(e&&this.launchInternal({task:e,command:"InitTask"},!0),this.state="Idle",this.triggerExecution()):o(this.logTag,"Attempted to initialize the Dispatcher, but it is already initialized. Ignoring.",r.Warn)}clear(e=!0){this.launchInternal({command:"Clear"},e),this.resume()}stop(e=!0){this.shuttingDown?this.clear(e):this.launchInternal({command:"Stop"},e)}resume(){"Stopped"===this.state&&(this.state="Idle",this.triggerExecution())}shutdown(){return this.shuttingDown=!0,this.launchInternal({command:"Shutdown"}),this.resume(),this.currentJob}testBlockOnQueue(){return n(this,void 0,void 0,(function*(){return yield this.currentJob}))}testUninitialize(){return n(this,void 0,void 0,(function*(){"Uninitialized"!==this.state&&(this.clear(),yield this.shutdown(),this.state="Uninitialized")}))}testLaunch(e){return new Promise(((t,i)=>{this.resume();this.launchInternal({resolver:t,task:e,command:"TestTask"})||i()}))}},v="core.Context";class b{constructor(){this.initialized=!1,this.testing=!1,this.supportedMetrics={},this.startTime=new Date,this.dispatcher=new y}static get instance(){return b._instance||(b._instance=new b),b._instance}static testUninitialize(){b._instance=void 0}static get dispatcher(){return b.instance.dispatcher}static get uploadEnabled(){return void 0===b.instance.uploadEnabled&&o(v,["Attempted to access Context.uploadEnabled before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.uploadEnabled}static set uploadEnabled(e){b.instance.uploadEnabled=e}static get metricsDatabase(){return void 0===b.instance.metricsDatabase&&o(v,["Attempted to access Context.metricsDatabase before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.metricsDatabase}static set metricsDatabase(e){b.instance.metricsDatabase=e}static get eventsDatabase(){return void 0===b.instance.eventsDatabase&&o(v,["Attempted to access Context.eventsDatabase before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.eventsDatabase}static set eventsDatabase(e){b.instance.eventsDatabase=e}static get pingsDatabase(){return void 0===b.instance.pingsDatabase&&o(v,["Attempted to access Context.pingsDatabase before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.pingsDatabase}static set pingsDatabase(e){b.instance.pingsDatabase=e}static get errorManager(){return void 0===b.instance.errorManager&&o(v,["Attempted to access Context.errorManager before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.errorManager}static set errorManager(e){b.instance.errorManager=e}static get applicationId(){return void 0===b.instance.applicationId&&o(v,["Attempted to access Context.applicationId before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.applicationId}static set applicationId(e){b.instance.applicationId=e}static get initialized(){return b.instance.initialized}static set initialized(e){b.instance.initialized=e}static get config(){return void 0===b.instance.config&&o(v,["Attempted to access Context.config before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.config}static set config(e){b.instance.config=e}static get startTime(){return b.instance.startTime}static get testing(){return b.instance.testing}static set testing(e){b.instance.testing=e}static get corePings(){return b.instance.corePings}static set corePings(e){b.instance.corePings=e}static get coreMetrics(){return b.instance.coreMetrics}static set coreMetrics(e){b.instance.coreMetrics=e}static set platform(e){b.instance.platform=e}static get platform(){return void 0===b.instance.platform&&o(v,["Attempted to access Context.platform before it was set. This may cause unexpected behaviour."],r.Trace),b.instance.platform}static isPlatformSet(){return!!b.instance.platform}static isPlatformSync(){var e;return"web"===(null===(e=b.instance.platform)||void 0===e?void 0:e.name)}static getSupportedMetric(e){return b.instance.supportedMetrics[e]}static addSupportedMetric(e,t){e in b.instance.supportedMetrics||(b.instance.supportedMetrics[e]=t)}}var w;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(w||(w={}));class S extends Error{constructor(e,t=i.InvalidType){super(e),this.type=t;try{this.name="MetricValidationError"}catch(e){}}recordError(e){return n(this,void 0,void 0,(function*(){yield b.errorManager.record(e,this.type,this.message)}))}recordErrorSync(e){b.errorManager.record(e,this.type,this.message)}}class E{constructor(e){this.inner=this.validateOrThrow(e)}get(){return this.inner}set(e){this.inner=e}validateOrThrow(e){const t=this.validate(e);if(t.type===w.Error)throw new S(t.errorMessage,t.errorType);return e}}function T(e){if(x(e)||P(e)||D(e))return!0;if(I(e)){if(0===Object.keys(e).length)return!0;for(const t in e)return T(e[t])}return!!Array.isArray(e)&&e.every((e=>T(e)))}function I(e){return"object"==typeof e&&null!==e&&e.constructor===Object}function M(e){return void 0===e}function x(e){return"string"==typeof e}function P(e){return"boolean"==typeof e}function D(e){return"number"==typeof e&&!isNaN(e)}function $(e){return D(e)&&Number.isInteger(e)}function A(e){return/^[a-z0-9-]{1,20}$/i.test(e)}function R(){return"undefined"!=typeof crypto?g():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}function U(){const e="undefined"==typeof performance?Date.now():performance.now();return Math.round(e)}function k(e,t,r){return n(this,void 0,void 0,(function*(){if(!x(t))throw new S(`Expected string, got ${JSON.stringify(t)}`);const n=t.substring(0,r);return n!==t&&(yield b.errorManager.record(e,i.InvalidOverflow,`Value length ${t.length} exceeds maximum of ${r}.`)),n}))}function N(e,t,n){if(!x(t))throw new S(`Expected string, got ${JSON.stringify(t)}`);const r=t.substring(0,n);return r!==t&&b.errorManager.record(e,i.InvalidOverflow,`Value length ${t.length} exceeds maximum of ${n}.`),r}function O(e,t="core.utils"){return!!b.testing||(o(t,[`Attempted to access test only method \`${e||"unknown"}\`,`,"but Glean is not in testing mode. Ignoring. Make sure to put Glean in testing mode","before accessing such methods, by calling `testResetGlean`."],r.Error),!1)}function G(...e){let t=e.reduce(((e,t)=>e+t),0);return t>Number.MAX_SAFE_INTEGER&&(t=Number.MAX_SAFE_INTEGER),t}function V(){let e;if("undefined"==typeof process)e=U();else{const t=process.hrtime();e=1e9*t[0]+t[1]}return e}function C(e,t){if(0===t.length)throw Error("The index must contain at least one property to get.");let i=e;for(const e of t){if(!I(i)||!(e in i))return;{const t=i[e];T(t)&&(i=t)}}return i}function _(e,t,i){if(0===t.length)throw Error("The index must contain at least one property to update.");const n=Object.assign({},e);let r=n;for(const e of t.slice(0,t.length-1))I(r[e])||(r[e]={}),r=r[e];const s=t[t.length-1],a=i(r[s]);return r[s]=a,n}let j={};const z=class{constructor(e){this.rootKey=e}get(e=[]){try{const t=C(j,[this.rootKey,...e]);return Promise.resolve(t)}catch(e){return Promise.reject(e)}}update(e,t){try{return j=_(j,[this.rootKey,...e],t),Promise.resolve()}catch(e){return Promise.reject(e)}}delete(e){try{j=function(e,t){if(0===t.length)return{};const i=Object.assign({},e);let n=i;for(const e of t.slice(0,t.length-1)){const i=n[e];if(!I(i))throw Error(`Attempted to delete an entry from an inexistent index: ${JSON.stringify(t)}.`);n=i}return delete n[t[t.length-1]],i}(j,[this.rootKey,...e])}catch(t){o("platform.test.Storage",[`Error attempting to delete key ${e.toString()} from storage. Ignoring.`,t],r.Warn)}return Promise.resolve()}};var L;!function(e){e[e.RecoverableFailure=0]="RecoverableFailure",e[e.UnrecoverableFailure=1]="UnrecoverableFailure",e[e.Success=2]="Success"}(L||(L={}));class F{constructor(e,t){this.result=e,this.status=t}}const W=class{};const B={os:()=>Promise.resolve("Unknown"),osVersion:()=>Promise.resolve("Unknown"),arch:()=>Promise.resolve("Unknown"),locale:()=>Promise.resolve("Unknown")},J="undefined"!=typeof setTimeout?setTimeout:()=>{throw new Error},q="undefined"!=typeof clearTimeout?clearTimeout:()=>{},H={Storage:z,uploader:new class extends W{post(e,t,i){const n=new F(2,200);return Promise.resolve(n)}},info:B,timer:{setTimeout:J,clearTimeout:q},name:"test"};class K{constructor(e){this.name=e}get registeredPluginIdentifier(){var e;return null===(e=this.plugin)||void 0===e?void 0:e.name}registerPlugin(e){this.plugin?o("core.Events",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,`That event is already watched by plugin '${this.plugin.name}'`,`Plugin '${e.name}' will be ignored.`],r.Error):this.plugin=e}deregisterPlugin(){this.plugin=void 0}trigger(...e){if(this.plugin)return this.plugin.action(...e)}}const Q={afterPingCollection:new K("afterPingCollection")};function X(e){const t=e.event;if(t in Q){Q[t].registerPlugin(e)}else o("core.Events.Utils",[`Attempted to register plugin '${e.name}', which listens to the event '${e.event}'.`,"That is not a valid Glean event. Ignoring"],r.Error)}const Z=1,Y="2.0.0-alpha.1",ee="glean_ping_info",te="glean_client_info",ie="c0ffeec0-ffee-c0ff-eec0-ffeec0ffeec0",ne="deletion-request",re="events",se="#glean_reference_time",ae="#glean_execution_counter",oe=[ae,se],ce="core.Config";class de{constructor(e){var t,i;if(this.channel=null==e?void 0:e.channel,this.appBuild=null==e?void 0:e.appBuild,this.appDisplayVersion=null==e?void 0:e.appDisplayVersion,this.architecture=null==e?void 0:e.architecture,this.osVersion=null==e?void 0:e.osVersion,this.buildDate=null==e?void 0:e.buildDate,this.maxEvents=(null==e?void 0:e.maxEvents)||500,this.debug={},(null==e?void 0:e.serverEndpoint)&&(i=e.serverEndpoint,!/^(http|https):\/\/[a-zA-Z0-9._-]+(:\d+){0,1}(\/{0,1})$/i.test(i)))throw new Error(`Unable to initialize Glean, serverEndpoint ${e.serverEndpoint} is an invalid URL.`);if(!b.testing&&(null===(t=null==e?void 0:e.serverEndpoint)||void 0===t?void 0:t.startsWith("http:")))throw new Error(`Unable to initialize Glean, serverEndpoint ${e.serverEndpoint} must use the HTTPS protocol.`);this.serverEndpoint=e&&e.serverEndpoint?e.serverEndpoint:"https://incoming.telemetry.mozilla.org",this.httpClient=null==e?void 0:e.httpClient}get logPings(){return this.debug.logPings||!1}set logPings(e){this.debug.logPings=e}get debugViewTag(){return this.debug.debugViewTag}set debugViewTag(e){A(e||"")?this.debug.debugViewTag=e:o(ce,[`"${e||""}" is not a valid \`debugViewTag\` value.`,"Please make sure the value passed satisfies the regex `^[a-zA-Z0-9-]{1,20}$`."],r.Error)}get sourceTags(){return this.debug.sourceTags}set sourceTags(e){if(!e||e.length<1||e.length>5)o(ce,"A list of tags cannot contain more than 5 elements or less than one.",r.Error);else{for(const t of e){if(t.startsWith("glean"))return void o(ce,"Tags starting with `glean` are reserved and must not be used.",r.Error);if(!A(t))return}this.debug.sourceTags=e}}}class ue extends E{constructor(e){super(e)}validate(e){return{type:w.Success}}payload(){return this.inner}}const le="__other__",he=/^[a-z_][a-z0-9_-]{0,29}(\.[a-z_][a-z0-9_-]{0,29})*$/;function fe(e,t){return`${e}/${t}`}class ge{constructor(e,t,i){return new Proxy(this,{get:(n,r)=>i?ge.createFromStaticLabel(e,t,i,r):ge.createFromDynamicLabel(e,t,r)})}static createFromStaticLabel(e,t,i,n){const r=i.includes(n)?n:le;return new t(Object.assign(Object.assign({},e),{name:fe(e.name,r)}))}static createFromDynamicLabel(e,t,i){return new t(Object.assign(Object.assign({},e),{dynamicLabel:i}))}}const me=ge;function pe(e,t){e.startsWith("labeled_")&&b.addSupportedMetric(e,ue);const i=b.getSupportedMetric(e);if(!i)throw new Error(`Unable to create metric of unknown type "${e}".`);return new i(t)}function ye(e,t){try{return pe(e,t),!0}catch(e){return o("Glean.core.Metrics.utils",e.message,r.Error),!1}}function ve(e,t=!0){if(!$(e))return{type:w.Error,errorMessage:`Expected integer value, got ${JSON.stringify(e)}`};return(t?e<0:e<=0)?{type:w.Error,errorMessage:`Expected positive value, got ${JSON.stringify(e)}`,errorType:i.InvalidValue}:{type:w.Success}}function be(e){return x(e)?{type:w.Success}:{type:w.Error,errorMessage:`Expected string value, got ${JSON.stringify(e)}`}}const we="core.Metrics.Database",Se="reserved#",Ee=`glean.${Se}`;const Te=class{constructor(){this.userStore=new b.platform.Storage("userLifetimeMetrics"),this.pingStore=new b.platform.Storage("pingLifetimeMetrics"),this.appStore=new b.platform.Storage("appLifetimeMetrics")}record(e,t){return n(this,void 0,void 0,(function*(){yield this.transform(e,(()=>t))}))}transform(e,t){return n(this,void 0,void 0,(function*(){if(e.disabled)return;const i=this.chooseStore(e.lifetime),n=yield e.identifier();for(const r of e.sendInPings){const s=e=>t(e).get();yield i.update([r,e.type,n],s)}}))}hasMetric(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this.chooseStore(e);return!M(yield n.get([t,i,r]))}))}countByBaseIdentifier(e,t,i,r){return n(this,void 0,void 0,(function*(){const n=this.chooseStore(e),s=yield n.get([t,i]);return M(s)?0:Object.keys(s).filter((e=>e.startsWith(r))).length}))}getMetric(e,t){return n(this,void 0,void 0,(function*(){const i=this.chooseStore(t.lifetime),n=yield t.identifier(),s=yield i.get([e,t.type,n]);return M(s)||ye(t.type,s)?s:(o(we,`Unexpected value found for metric ${n}: ${JSON.stringify(s)}. Clearing.`,r.Error),void(yield i.delete([e,t.type,n])))}))}getPingMetrics(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getCorrectedPingData(e,"user"),n=yield this.getCorrectedPingData(e,"ping"),r=yield this.getCorrectedPingData(e,"application");t&&Object.keys(n).length>0&&(yield this.clear("ping",e));const s={};for(const e of[i,n,r])for(const t in e)for(const i in e[t])i.startsWith(Ee)||(i.includes("/")?this.processLabeledMetric(s,t,i,e[t][i]):s[t]=Object.assign(Object.assign({},s[t]),{[i]:e[t][i]}));return 0===Object.keys(s).length?void 0:function(e){const t={};for(const i in e){const n=e[i];t[i]={};for(const e in n){const r=pe(i,n[e]);t[i][e]=r.payload()}}return t}(s)}))}clear(e,t){return n(this,void 0,void 0,(function*(){const i=this.chooseStore(e),n=t?[t]:[];yield i.delete(n)}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.userStore.delete([]),yield this.pingStore.delete([]),yield this.appStore.delete([])}))}chooseStore(e){switch(e){case"user":return this.userStore;case"ping":return this.pingStore;case"application":return this.appStore}}getCorrectedPingData(e,t){return n(this,void 0,void 0,(function*(){const i=this.chooseStore(t),n=yield i.get([e]);if(M(n))return{};if(!I(n))return o(we,`Invalid value found in storage for ping "${e}". Deleting.`,r.Debug),yield i.delete([e]),{};const s={};for(const t in n){const a=n[t];if(I(a))for(const n in a)ye(t,a[n])?(s[t]||(s[t]={}),s[t][n]=a[n]):(o(we,`Invalid value "${JSON.stringify(a[n])}" found in storage for metric "${n}". Deleting.`,r.Debug),yield i.delete([e,t,n]));else o(we,`Unexpected data found in storage for metrics of type "${t}" in ping "${e}". Deleting.`,r.Debug),yield i.delete([e,t])}return s}))}processLabeledMetric(e,t,i,n){const r=`labeled_${t}`,s=i.split("/",2),a=s[0],o=s[1];if(r in e&&a in e[r]){const t=e[r][a];e[r][a]=Object.assign(Object.assign({},t),{[o]:n})}else e[r]=Object.assign(Object.assign({},e[r]),{[a]:{[o]:n}})}};var Ie=Uint8Array,Me=Uint16Array,xe=Uint32Array,Pe=new Ie([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),De=new Ie([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),$e=new Ie([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ae=function(e,t){for(var i=new Me(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var r=new xe(i[30]);for(n=1;n<30;++n)for(var s=i[n];s<i[n+1];++s)r[s]=s-i[n]<<5|n;return[i,r]},Re=Ae(Pe,2),Ue=Re[0],ke=Re[1];Ue[28]=258,ke[258]=28;for(var Ne=Ae(De,0),Oe=(Ne[0],Ne[1]),Ge=new Me(32768),Ve=0;Ve<32768;++Ve){var Ce=(43690&Ve)>>>1|(21845&Ve)<<1;Ce=(61680&(Ce=(52428&Ce)>>>2|(13107&Ce)<<2))>>>4|(3855&Ce)<<4,Ge[Ve]=((65280&Ce)>>>8|(255&Ce)<<8)>>>1}var _e=function(e,t,i){for(var n=e.length,r=0,s=new Me(t);r<n;++r)e[r]&&++s[e[r]-1];var a,o=new Me(t);for(r=0;r<t;++r)o[r]=o[r-1]+s[r-1]<<1;if(i){a=new Me(1<<t);var c=15-t;for(r=0;r<n;++r)if(e[r])for(var d=r<<4|e[r],u=t-e[r],l=o[e[r]-1]++<<u,h=l|(1<<u)-1;l<=h;++l)a[Ge[l]>>>c]=d}else for(a=new Me(n),r=0;r<n;++r)e[r]&&(a[r]=Ge[o[e[r]-1]++]>>>15-e[r]);return a},je=new Ie(288);for(Ve=0;Ve<144;++Ve)je[Ve]=8;for(Ve=144;Ve<256;++Ve)je[Ve]=9;for(Ve=256;Ve<280;++Ve)je[Ve]=7;for(Ve=280;Ve<288;++Ve)je[Ve]=8;var ze=new Ie(32);for(Ve=0;Ve<32;++Ve)ze[Ve]=5;var Le=_e(je,9,0),Fe=_e(ze,5,0),We=function(e){return(e+7)/8|0},Be=function(e,t,i){(null==t||t<0)&&(t=0),(null==i||i>e.length)&&(i=e.length);var n=new(2==e.BYTES_PER_ELEMENT?Me:4==e.BYTES_PER_ELEMENT?xe:Ie)(i-t);return n.set(e.subarray(t,i)),n},Je=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8},qe=function(e,t,i){i<<=7&t;var n=t/8|0;e[n]|=i,e[n+1]|=i>>>8,e[n+2]|=i>>>16},He=function(e,t){for(var i=[],n=0;n<e.length;++n)e[n]&&i.push({s:n,f:e[n]});var r=i.length,s=i.slice();if(!r)return[tt,0];if(1==r){var a=new Ie(i[0].s+1);return a[i[0].s]=1,[a,1]}i.sort((function(e,t){return e.f-t.f})),i.push({s:-1,f:25001});var o=i[0],c=i[1],d=0,u=1,l=2;for(i[0]={s:-1,f:o.f+c.f,l:o,r:c};u!=r-1;)o=i[i[d].f<i[l].f?d++:l++],c=i[d!=u&&i[d].f<i[l].f?d++:l++],i[u++]={s:-1,f:o.f+c.f,l:o,r:c};var h=s[0].s;for(n=1;n<r;++n)s[n].s>h&&(h=s[n].s);var f=new Me(h+1),g=Ke(i[u-1],f,0);if(g>t){n=0;var m=0,p=g-t,y=1<<p;for(s.sort((function(e,t){return f[t.s]-f[e.s]||e.f-t.f}));n<r;++n){var v=s[n].s;if(!(f[v]>t))break;m+=y-(1<<g-f[v]),f[v]=t}for(m>>>=p;m>0;){var b=s[n].s;f[b]<t?m-=1<<t-f[b]++-1:++n}for(;n>=0&&m;--n){var w=s[n].s;f[w]==t&&(--f[w],++m)}g=t}return[new Ie(f),g]},Ke=function(e,t,i){return-1==e.s?Math.max(Ke(e.l,t,i+1),Ke(e.r,t,i+1)):t[e.s]=i},Qe=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new Me(++t),n=0,r=e[0],s=1,a=function(e){i[n++]=e},o=1;o<=t;++o)if(e[o]==r&&o!=t)++s;else{if(!r&&s>2){for(;s>138;s-=138)a(32754);s>2&&(a(s>10?s-11<<5|28690:s-3<<5|12305),s=0)}else if(s>3){for(a(r),--s;s>6;s-=6)a(8304);s>2&&(a(s-3<<5|8208),s=0)}for(;s--;)a(r);s=1,r=e[o]}return[i.subarray(0,n),t]},Xe=function(e,t){for(var i=0,n=0;n<t.length;++n)i+=e[n]*t[n];return i},Ze=function(e,t,i){var n=i.length,r=We(t+2);e[r]=255&n,e[r+1]=n>>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var s=0;s<n;++s)e[r+s+4]=i[s];return 8*(r+4+n)},Ye=function(e,t,i,n,r,s,a,o,c,d,u){Je(t,u++,i),++r[256];for(var l=He(r,15),h=l[0],f=l[1],g=He(s,15),m=g[0],p=g[1],y=Qe(h),v=y[0],b=y[1],w=Qe(m),S=w[0],E=w[1],T=new Me(19),I=0;I<v.length;++I)T[31&v[I]]++;for(I=0;I<S.length;++I)T[31&S[I]]++;for(var M=He(T,7),x=M[0],P=M[1],D=19;D>4&&!x[$e[D-1]];--D);var $,A,R,U,k=d+5<<3,N=Xe(r,je)+Xe(s,ze)+a,O=Xe(r,h)+Xe(s,m)+a+14+3*D+Xe(T,x)+(2*T[16]+3*T[17]+7*T[18]);if(k<=N&&k<=O)return Ze(t,u,e.subarray(c,c+d));if(Je(t,u,1+(O<N)),u+=2,O<N){$=_e(h,f,0),A=h,R=_e(m,p,0),U=m;var G=_e(x,P,0);Je(t,u,b-257),Je(t,u+5,E-1),Je(t,u+10,D-4),u+=14;for(I=0;I<D;++I)Je(t,u+3*I,x[$e[I]]);u+=3*D;for(var V=[v,S],C=0;C<2;++C){var _=V[C];for(I=0;I<_.length;++I){var j=31&_[I];Je(t,u,G[j]),u+=x[j],j>15&&(Je(t,u,_[I]>>>5&127),u+=_[I]>>>12)}}}else $=Le,A=je,R=Fe,U=ze;for(I=0;I<o;++I)if(n[I]>255){j=n[I]>>>18&31;qe(t,u,$[j+257]),u+=A[j+257],j>7&&(Je(t,u,n[I]>>>23&31),u+=Pe[j]);var z=31&n[I];qe(t,u,R[z]),u+=U[z],z>3&&(qe(t,u,n[I]>>>5&8191),u+=De[z])}else qe(t,u,$[n[I]]),u+=A[n[I]];return qe(t,u,$[256]),u+A[256]},et=new xe([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),tt=new Ie(0),it=function(e,t,i,n,r,s){var a=e.length,o=new Ie(n+a+5*(1+Math.ceil(a/7e3))+r),c=o.subarray(n,o.length-r),d=0;if(!t||a<8)for(var u=0;u<=a;u+=65535){var l=u+65535;l>=a&&(c[d>>3]=s),d=Ze(c,d+1,e.subarray(u,l))}else{for(var h=et[t-1],f=h>>>13,g=8191&h,m=(1<<i)-1,p=new Me(32768),y=new Me(m+1),v=Math.ceil(i/3),b=2*v,w=function(t){return(e[t]^e[t+1]<<v^e[t+2]<<b)&m},S=new xe(25e3),E=new Me(288),T=new Me(32),I=0,M=0,x=(u=0,0),P=0,D=0;u<a;++u){var $=w(u),A=32767&u,R=y[$];if(p[A]=R,y[$]=A,P<=u){var U=a-u;if((I>7e3||x>24576)&&U>423){d=Ye(e,c,0,S,E,T,M,x,D,u-D,d),x=I=M=0,D=u;for(var k=0;k<286;++k)E[k]=0;for(k=0;k<30;++k)T[k]=0}var N=2,O=0,G=g,V=A-R&32767;if(U>2&&$==w(u-V))for(var C=Math.min(f,U)-1,_=Math.min(32767,u),j=Math.min(258,U);V<=_&&--G&&A!=R;){if(e[u+N]==e[u+N-V]){for(var z=0;z<j&&e[u+z]==e[u+z-V];++z);if(z>N){if(N=z,O=V,z>C)break;var L=Math.min(V,z-2),F=0;for(k=0;k<L;++k){var W=u-V+k+32768&32767,B=W-p[W]+32768&32767;B>F&&(F=B,R=W)}}}V+=(A=R)-(R=p[A])+32768&32767}if(O){S[x++]=268435456|ke[N]<<18|Oe[O];var J=31&ke[N],q=31&Oe[O];M+=Pe[J]+De[q],++E[257+J],++T[q],P=u+N,++I}else S[x++]=e[u],++E[e[u]]}}d=Ye(e,c,s,S,E,T,M,x,D,u-D,d),!s&&7&d&&(d=Ze(c,d+1,tt))}return Be(o,0,n+We(d)+r)},nt=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var i=t,n=9;--n;)i=(1&i&&-306674912)^i>>>1;e[t]=i}return e}(),rt=function(){var e=-1;return{p:function(t){for(var i=e,n=0;n<t.length;++n)i=nt[255&i^t[n]]^i>>>8;e=i},d:function(){return~e}}},st=function(e,t,i,n,r){return it(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,i,n,!r)},at=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8},ot=function(e,t){var i=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&at(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),i){e[3]=8;for(var n=0;n<=i.length;++n)e[n+10]=i.charCodeAt(n)}},ct=function(e){return 10+(e.filename&&e.filename.length+1||0)};function dt(e,t){t||(t={});var i=rt(),n=e.length;i.p(e);var r=st(e,t,ct(t),8),s=r.length;return ot(r,t),at(r,s-8,i.d()),at(r,s-4,n),r}var ut="undefined"!=typeof TextEncoder&&new TextEncoder,lt="undefined"!=typeof TextDecoder&&new TextDecoder;try{lt.decode(tt,{stream:!0}),1}catch(e){}function ht(e,t){if(t){for(var i=new Ie(e.length),n=0;n<e.length;++n)i[n]=e.charCodeAt(n);return i}if(ut)return ut.encode(e);var r=e.length,s=new Ie(e.length+(e.length>>1)),a=0,o=function(e){s[a++]=e};for(n=0;n<r;++n){if(a+5>s.length){var c=new Ie(a+8+(r-n<<1));c.set(s),s=c}var d=e.charCodeAt(n);d<128||t?o(d):d<2048?(o(192|d>>6),o(128|63&d)):d>55295&&d<57344?(o(240|(d=65536+(1047552&d)|1023&e.charCodeAt(++n))>>18),o(128|d>>12&63),o(128|d>>6&63),o(128|63&d)):(o(224|d>>12),o(128|d>>6&63),o(128|63&d))}return Be(s,0,a)}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;const ft="core.Pings.Database";function gt(e){return e.path.split("/")[3]===ne}function mt(e){return ht(JSON.stringify(e)).length}function pt(e){if(I(e)){const t="collectionDate"in e&&x(e.collectionDate)&&D(new Date(e.collectionDate).getTime()),i="path"in e&&x(e.path),n="payload"in e&&T(e.payload)&&I(e.payload),r=!("headers"in e)||T(e.headers)&&I(e.headers);return!!(t&&i&&n&&r)}return!1}const yt=class{constructor(){this.store=new b.platform.Storage("pings")}attachObserver(e){this.observer=e}recordPing(e,t,i,r){return n(this,void 0,void 0,(function*(){const n={collectionDate:(new Date).toISOString(),path:e,payload:i};r&&(n.headers=r),yield this.store.update([t],(()=>n)),this.observer&&this.observer.update(t,n)}))}deletePing(e){return n(this,void 0,void 0,(function*(){yield this.store.delete([e])}))}getAllPings(){return n(this,void 0,void 0,(function*(){const e=yield this.store.get(),t={};if(I(e))for(const i in e){const n=e[i];pt(n)?t[i]=n:(o(ft,`Unexpected data found in pings database: ${JSON.stringify(n,null,2)}. Deleting.`,r.Warn),yield this.store.delete([i]))}return i=t,Object.entries(i).sort((([e,{collectionDate:t}],[i,{collectionDate:n}])=>new Date(t).getTime()-new Date(n).getTime()));var i}))}scanPendingPings(){return n(this,void 0,void 0,(function*(){if(!this.observer)return;const e=yield this.getAllPingsWithoutSurplus();for(const[t,i]of e)this.observer.update(t,i)}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.store.delete([])}))}getAllPingsWithoutSurplus(e=250,t=10485760){return n(this,void 0,void 0,(function*(){const i=yield this.getAllPings(),n=i.filter((([e,t])=>!gt(t))).reverse(),s=i.filter((([e,t])=>gt(t))),a=n.length;a>e&&o(ft,[`More than ${e} pending pings in the pings database,`,`will delete ${a-e} old pings.`],r.Warn);let c=!1,d=0,u=0;const l=[];for(const[i,s]of n)d++,u+=mt(s),!c&&u>t&&(o(ft,[`Pending pings database has reached the size quota of ${t} bytes,`,"outstanding pings will be deleted."],r.Warn),c=!0),d>e&&(c=!0),c?yield this.deletePing(i):l.unshift([i,s]);return[...s,...l]}))}};var vt;!function(e){e[e.Incrementing=0]="Incrementing",e[e.Throttled=1]="Throttled"}(vt||(vt={}));const bt=class{constructor(e=6e4,t=40,i=0,n){this.interval=e,this.maxCount=t,this.count=i,this.started=n}get elapsed(){if(M(this.started))return NaN;const e=U()-this.started;return e<0?NaN:e}reset(){this.started=U(),this.count=0}shouldReset(){return!!M(this.started)||!!(isNaN(this.elapsed)||this.elapsed>this.interval)}getState(){this.shouldReset()&&this.reset();const e=this.interval-this.elapsed;return this.count>=this.maxCount?{state:1,remainingTime:e}:(this.count++,{state:0})}};class wt{constructor(e=3,t=3,i=1048576){this.maxWaitAttempts=e,this.maxRecoverableFailures=t,this.maxPingBodySize=i}}const St="core.Upload.PingUploadWorker";class Et extends Error{constructor(e){super(e),this.name="PingBodyOverflow"}}const Tt=class{constructor(e,t,i=new wt){this.uploader=e,this.serverEndpoint=t,this.policy=i,this.isBlocking=!1}buildPingRequest(e){return n(this,void 0,void 0,(function*(){let t=e.headers||{};t=Object.assign(Object.assign({},e.headers),{"Content-Type":"application/json; charset=utf-8",Date:(new Date).toISOString(),"X-Telemetry-Agent":`Glean/${Y} (JS on ${yield b.platform.info.os()})`});const i=JSON.stringify(e.payload),n=ht(i);let r,s;try{r=dt(n),s=r.length,t["Content-Encoding"]="gzip"}catch(e){r=i,s=n.length}if(s>this.policy.maxPingBodySize)throw new Et(`Body for ping ${e.identifier} exceeds ${this.policy.maxPingBodySize}bytes. Discarding.`);return t["Content-Length"]=s.toString(),{headers:t,payload:r}}))}attemptPingUpload(e){return n(this,void 0,void 0,(function*(){try{const t=yield this.buildPingRequest(e);return yield this.uploader.post(`${this.serverEndpoint}${e.path}`,t.payload,t.headers)}catch(e){return o(St,["Error trying to build or post ping request:",e],r.Warn),new F(1)}}))}workInternal(e,t){return n(this,void 0,void 0,(function*(){for(;;){const i=e();switch(i.type){case"upload":const e=yield this.attemptPingUpload(i.ping);yield t(i.ping,e);continue;case"wait":if(this.isBlocking)return;try{if(yield new Promise((e=>{this.waitPromiseResolver=e,this.waitTimeoutId=b.platform.timer.setTimeout((()=>{this.waitPromiseResolver=void 0,this.waitTimeoutId=void 0,e(!1)}),i.remainingTime)})))return}catch(e){return this.waitPromiseResolver=void 0,void(this.waitTimeoutId=void 0)}continue;case"done":return}}}))}work(e,t){this.currentJob||(this.currentJob=this.workInternal(e,t).then((()=>{this.currentJob=void 0})).catch((e=>{o(St,["IMPOSSIBLE: Something went wrong while processing ping upload tasks.",e],r.Error)})))}blockOnCurrentJob(){return n(this,void 0,void 0,(function*(){return this.currentJob?(this.waitTimeoutId&&this.waitPromiseResolver&&(b.platform.timer.clearTimeout(this.waitTimeoutId),this.waitPromiseResolver(!0),this.waitPromiseResolver=void 0,this.waitTimeoutId=void 0),this.isBlocking=!0,yield this.currentJob,void(this.isBlocking=!1)):Promise.resolve()}))}};var It;!function(e){e.Done="done",e.Wait="wait",e.Upload="upload"}(It||(It={}));const Mt=()=>({type:"done"}),xt=e=>({type:"wait",remainingTime:e}),Pt=e=>({type:"upload",ping:e}),Dt="core.Upload.PingUploadManager";const $t=class{constructor(e,t,i=new wt,n=new bt){this.pingsDatabase=t,this.policy=i,this.rateLimiter=n,this.recoverableFailureCount=0,this.waitAttemptCount=0,this.queue=[],this.processing=new Set,this.worker=new Tt(e.httpClient?e.httpClient:b.platform.uploader,e.serverEndpoint,i),t.attachObserver(this)}getUploadTask(){const e=this.getUploadTaskInternal();return"wait"!==e.type&&this.waitAttemptCount>0&&(this.waitAttemptCount=0),"upload"!==e.type&&this.recoverableFailureCount>0&&(this.recoverableFailureCount=0),e}processPingUploadResponse(e,t){return n(this,void 0,void 0,(function*(){const{identifier:i}=e;this.processing.delete(i);const{status:n,result:s}=t;return n&&n>=200&&n<300?(o(Dt,`Ping ${i} successfully sent ${n}.`,r.Info),void(yield this.pingsDatabase.deletePing(i))):1===s||n&&n>=400&&n<500?(o(Dt,`Unrecoverable upload failure while attempting to send ping ${i}. Error was: ${null!=n?n:"no status"}.`,r.Warn),void(yield this.pingsDatabase.deletePing(i))):(o(Dt,[`Recoverable upload failure while attempting to send ping ${i}, will retry.`,`Error was: ${null!=n?n:"no status"}.`],r.Warn),this.recoverableFailureCount++,void this.enqueuePing(e))}))}clearPendingPingsQueue(){return n(this,void 0,void 0,(function*(){this.queue=this.queue.filter((e=>gt(e))),yield this.blockOnOngoingUploads()}))}blockOnOngoingUploads(){return n(this,void 0,void 0,(function*(){return this.worker.blockOnCurrentJob()}))}update(e,t){this.enqueuePing(Object.assign({identifier:e},t)),this.worker.work((()=>this.getUploadTask()),((e,t)=>this.processPingUploadResponse(e,t)))}enqueuePing(e){if(!this.processing.has(e.identifier)){for(const t of this.queue)if(t.identifier===e.identifier)return;this.queue.push(e)}}getUploadTaskInternal(){if(this.recoverableFailureCount>=this.policy.maxRecoverableFailures)return o(Dt,"Glean has reached maximum recoverable upload failures for the current uploading window.",r.Debug),Mt();if(this.queue.length>0){const{state:e,remainingTime:t}=this.rateLimiter.getState();if(1===e)return o(Dt,["Glean is currently throttled.",`Pending pings may be uploaded in ${(t||0)/1e3}s.`],r.Debug),this.waitAttemptCount++,this.waitAttemptCount>this.policy.maxWaitAttempts?Mt():xt(t||0);const i=this.queue.shift();return this.processing.add(i.identifier),Pt(i)}return Mt()}};class At{constructor(e,t,i){i&&b.addSupportedMetric(e,i),this.type=e,this.name=t.name,this.category=t.category,this.sendInPings=t.sendInPings,this.lifetime=t.lifetime,this.disabled=t.disabled,this.dynamicLabel=t.dynamicLabel}baseIdentifier(){return this.category.length>0?`${this.category}.${this.name}`:this.name}identifier(){return n(this,void 0,void 0,(function*(){const e=this.baseIdentifier();return M(this.dynamicLabel)?e:yield function(e){return n(this,void 0,void 0,(function*(){if(void 0===e.dynamicLabel)throw new Error("This point should never be reached.");const t=fe(e.baseIdentifier(),e.dynamicLabel);for(const i of e.sendInPings)if(yield b.metricsDatabase.hasMetric(e.lifetime,i,e.type,t))return t;let n=0;for(const t of e.sendInPings)n+=(yield b.metricsDatabase.countByBaseIdentifier(e.lifetime,t,e.type,e.baseIdentifier()));let r=!1;return n>=16?r=!0:e.dynamicLabel.length>61?(r=!0,yield b.errorManager.record(e,i.InvalidLabel,`Label length ${e.dynamicLabel.length} exceeds maximum of 61.`)):he.test(e.dynamicLabel)||(r=!0,yield b.errorManager.record(e,i.InvalidLabel,`Label must be snake_case, got '${e.dynamicLabel}'.`)),r?fe(e.baseIdentifier(),le):t}))}(this)}))}identifierSync(){const e=this.baseIdentifier();return M(this.dynamicLabel)?e:function(e){if(void 0===e.dynamicLabel)throw new Error("This point should never be reached.");const t=fe(e.baseIdentifier(),e.dynamicLabel);for(const i of e.sendInPings)if(b.metricsDatabase.hasMetric(e.lifetime,i,e.type,t))return t;let n=0;for(const t of e.sendInPings)n+=b.metricsDatabase.countByBaseIdentifier(e.lifetime,t,e.type,e.baseIdentifier());let r=!1;return n>=16?r=!0:e.dynamicLabel.length>61?(r=!0,b.errorManager.record(e,i.InvalidLabel,`Label length ${e.dynamicLabel.length} exceeds maximum of 61.`)):he.test(e.dynamicLabel)||(r=!0,b.errorManager.record(e,i.InvalidLabel,`Label must be snake_case, got '${e.dynamicLabel}'.`)),r?fe(e.baseIdentifier(),le):t}(this)}shouldRecord(e){return e&&!this.disabled}testGetNumRecordedErrors(e,t=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){return O("testGetNumRecordedErrors")?b.errorManager.testGetNumRecordedErrors(this,e,t):0}))}}var Rt;const Ut=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;class kt extends E{constructor(e){super(e)}validate(e){const t=be(e);if(t.type===w.Error)return t;const n=e;return Ut.test(n)?{type:w.Success}:{type:w.Error,errorMessage:`"${n}" is not a valid UUID`,errorType:i.InvalidValue}}payload(){return this.inner}}class Nt extends At{constructor(e){super("uuid",e,kt)}set(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}generateAndSet(){if(!this.shouldRecord(b.uploadEnabled))return;const e=R();return this.set(e),e}setAsync(e){b.dispatcher.launch((()=>this.setUndispatched(e)))}setUndispatched(e){return n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;let t;e||(e=R());try{t=new kt(e),yield b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&(yield e.recordError(this))}}))}setSync(e){if(!this.shouldRecord(b.uploadEnabled))return;let t;e||(e=R());try{t=new kt(e),b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.UUIDMetricType")){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}var Ot;function Gt(e,t){switch(t){case Ot.Nanosecond:return e;case Ot.Microsecond:return 1e3*e;case Ot.Millisecond:return e*10**6;case Ot.Second:return e*10**9;case Ot.Minute:return e*10**9*60;case Ot.Hour:return e*10**9*60*60;case Ot.Day:return e*10**9*60*60*24}}Rt=new WeakMap,function(e){e.Nanosecond="nanosecond",e.Microsecond="microsecond",e.Millisecond="millisecond",e.Second="second",e.Minute="minute",e.Hour="hour",e.Day="day"}(Ot||(Ot={}));const Vt=Ot;var Ct;class _t extends E{constructor(e){super(e)}static fromDate(e,t){if(!(e instanceof Date))throw new S(`Expected Date object, got ${JSON.stringify(e)}`);return new _t({timeUnit:t,timezone:e.getTimezoneOffset(),date:e.toISOString()})}static fromRawDatetime(e,t,i){return new _t({timeUnit:i,timezone:t,date:e})}get date(){return new Date(this.inner.date)}get timezone(){return this.inner.timezone}get timeUnit(){return this.inner.timeUnit}get dateISOString(){return this.inner.date}validate(e){if(!I(e)||3!==Object.keys(e).length)return{type:w.Error,errorMessage:`Expected Glean datetime metric object, got ${JSON.stringify(e)}`};const t="timeUnit"in e&&x(e.timeUnit)&&Object.values(Vt).includes(e.timeUnit),i="timezone"in e&&D(e.timezone),n="date"in e&&x(e.date)&&24===e.date.length&&!isNaN(Date.parse(e.date));return t&&i&&n?{type:w.Success}:{type:w.Error,errorMessage:`Invalid property on datetime metric, got ${JSON.stringify(e)}`}}payload(){const e=this.dateISOString.match(/\d+/g);if(!e||e.length<0)throw new Error("IMPOSSIBLE: Unable to extract date information from DatetimeMetric.");const t=new Date(parseInt(e[0]),parseInt(e[1])-1,parseInt(e[2]),parseInt(e[3])-this.timezone/60,parseInt(e[4]),parseInt(e[5]),parseInt(e[6])),i=function(e){const t=e/60*-1;return`${t>0?"+":"-"}${Math.abs(t).toString().padStart(2,"0")}:00`}(this.timezone),n=t.getFullYear().toString().padStart(2,"0"),r=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");if(this.timeUnit===Vt.Day)return`${n}-${r}-${s}${i}`;const a=t.getHours().toString().padStart(2,"0");if(this.timeUnit===Vt.Hour)return`${n}-${r}-${s}T${a}${i}`;const o=t.getMinutes().toString().padStart(2,"0");if(this.timeUnit===Vt.Minute)return`${n}-${r}-${s}T${a}:${o}${i}`;const c=t.getSeconds().toString().padStart(2,"0");if(this.timeUnit===Vt.Second)return`${n}-${r}-${s}T${a}:${o}:${c}${i}`;const d=t.getMilliseconds().toString().padStart(3,"0");return this.timeUnit===Vt.Millisecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}${i}`:this.timeUnit===Vt.Microsecond?`${n}-${r}-${s}T${a}:${o}:${c}.${d}000${i}`:`${n}-${r}-${s}T${a}:${o}:${c}.${d}000000${i}`}}class jt extends At{constructor(e,t){super("datetime",e,_t),this.timeUnit=t}set(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}truncateDate(e){e||(e=new Date);const t=e;switch(this.timeUnit){case Vt.Day:t.setMilliseconds(0),t.setSeconds(0),t.setMinutes(0),t.setMilliseconds(0);case Vt.Hour:t.setMilliseconds(0),t.setSeconds(0),t.setMinutes(0);case Vt.Minute:t.setMilliseconds(0),t.setSeconds(0);case Vt.Second:t.setMilliseconds(0)}return t}setAsync(e){b.dispatcher.launch((()=>this.setUndispatched(e)))}setUndispatched(e){return n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;const t=this.truncateDate(e);try{const e=_t.fromDate(t,this.timeUnit);yield b.metricsDatabase.record(this,e)}catch(e){e instanceof S&&(yield e.recordError(this))}}))}setSync(e){if(!this.shouldRecord(b.uploadEnabled))return;const t=this.truncateDate(e);try{const e=_t.fromDate(t,this.timeUnit);b.metricsDatabase.record(this,e)}catch(e){e instanceof S&&e.recordErrorSync(this)}}setSyncRaw(e,t,i){if(this.shouldRecord(b.uploadEnabled))try{const n=_t.fromRawDatetime(e,t,i);b.metricsDatabase.record(this,n)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValueAsDatetimeMetric(e,t){return n(this,void 0,void 0,(function*(){if(O(t,"core.metrics.DatetimeMetricType")){let t;if(yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t)return new _t(t)}}))}testGetValueAsString(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e,"testGetValueAsString");return t?t.payload():void 0}))}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){const t=yield this.testGetValueAsDatetimeMetric(e,"testGetValue");return t?t.date:void 0}))}}var zt;Ct=new WeakMap;class Lt extends E{constructor(e){super(e)}validate(e){return be(e)}payload(){return this.inner}}class Ft extends At{constructor(e){super("string",e,Lt)}set(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}setAsync(e){b.dispatcher.launch((()=>this.setUndispatched(e)))}setUndispatched(e){return n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{const t=yield k(this,e,100),i=new Lt(t);yield b.metricsDatabase.record(this,i)}catch(e){e instanceof S&&(yield e.recordError(this))}}))}setSync(e){if(this.shouldRecord(b.uploadEnabled))try{const t=N(this,e,100),i=new Lt(t);b.metricsDatabase.record(this,i)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.StringMetricType")){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}zt=new WeakMap;class Wt{constructor(){this.clientId=new Nt({name:"client_id",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1}),this.firstRunDate=new jt({name:"first_run_date",category:"",sendInPings:["glean_client_info"],lifetime:"user",disabled:!1},Vt.Day),this.os=new Ft({name:"os",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.osVersion=new Ft({name:"os_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.architecture=new Ft({name:"architecture",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.locale=new Ft({name:"locale",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appChannel=new Ft({name:"app_channel",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appBuild=new Ft({name:"app_build",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.appDisplayVersion=new Ft({name:"app_display_version",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1}),this.buildDate=new jt({name:"build_date",category:"",sendInPings:["glean_client_info"],lifetime:"application",disabled:!1},"second")}initialize(){return n(this,void 0,void 0,(function*(){yield this.initializeClientId(),yield this.initializeFirstRunDate(),yield this.os.setUndispatched(yield b.platform.info.os()),yield this.osVersion.setUndispatched(yield b.platform.info.osVersion(b.config.osVersion)),yield this.architecture.setUndispatched(yield b.platform.info.arch(b.config.architecture)),yield this.locale.setUndispatched(yield b.platform.info.locale()),yield this.appBuild.setUndispatched(b.config.appBuild||"Unknown"),yield this.appDisplayVersion.setUndispatched(b.config.appDisplayVersion||"Unknown"),b.config.channel&&(yield this.appChannel.setUndispatched(b.config.channel)),b.config.buildDate&&(yield this.buildDate.setUndispatched())}))}initializeClientId(){return n(this,void 0,void 0,(function*(){let e=!1;const t=yield b.metricsDatabase.getMetric(te,this.clientId);if(t)try{pe("uuid",t).payload()===ie&&(e=!0)}catch(t){o("core.InternalMetrics","Unexpected value found for Glean clientId. Ignoring.",r.Warn),e=!0}else e=!0;e&&(yield this.clientId.setUndispatched(R()))}))}initializeFirstRunDate(){return n(this,void 0,void 0,(function*(){(yield b.metricsDatabase.getMetric(te,this.firstRunDate))||(yield this.firstRunDate.setUndispatched())}))}}class Bt extends E{constructor(e){super(e)}static withTransformedExtras(e,t){const i=t(e.extra||{});return{category:e.category,name:e.name,timestamp:e.timestamp,extra:i&&Object.keys(i).length>0?i:void 0}}addExtra(e,t){this.inner.extra||(this.inner.extra={}),this.inner.extra[e]=t}withoutReservedExtras(){return Bt.withTransformedExtras(this.get(),(e=>Object.keys(e).filter((e=>!oe.includes(e))).reduce(((t,i)=>(t[i]=e[i],t)),{})))}validate(e){if(!I(e))return{type:w.Error,errorMessage:"Expected Glean event object, got "+typeof e};const t="category"in e&&x(e.category),i="name"in e&&x(e.name);if(!t||!i)return{type:w.Error,errorMessage:`Unexpected value for "category" or "name" in event object: ${JSON.stringify(e)}`};if(!("timestamp"in e&&$(e.timestamp)&&e.timestamp>=0))return{type:w.Error,errorMessage:`Event timestamp must be a positive integer, got ${JSON.stringify(e)}`};if(e.extra){if(!I(e.extra))return{type:w.Error,errorMessage:"Expected Glean extras object, got "+typeof e};for(const[t,i]of Object.entries(e.extra)){const e=be(t);if(e.type===w.Error)return e;if(!x(i)&&!D(i)&&!P(i))return{type:w.Error,errorMessage:`Unexpected value for extra key ${t}: ${JSON.stringify(i)}`}}}return{type:w.Success}}payload(){return Bt.withTransformedExtras(this.withoutReservedExtras(),(e=>Object.keys(e).reduce(((t,i)=>(t[i]=e[i].toString(),t)),{})))}}var Jt;const qt="core.metrics.CounterMetricType";class Ht extends E{constructor(e){super(e)}validate(e){return ve(e,!1)}payload(){return this.inner}saturatingAdd(e){const t=this.validateOrThrow(e);this.inner=G(this.inner,t)}}class Kt extends At{constructor(e){super("counter",e,Ht)}add(e){b.isPlatformSync()?this.addSync(e):this.addAsync(e)}transformFn(e){return t=>{const i=new Ht(e);if(t)try{i.saturatingAdd(t)}catch(e){o(qt,`Unexpected value found in storage for metric ${this.name}: ${JSON.stringify(t)}. Overwriting.`)}return i}}addAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){return this.addUndispatched(e)}))))}addUndispatched(e){return n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled)){M(e)&&(e=1);try{yield b.metricsDatabase.transform(this,this.transformFn(e))}catch(e){e instanceof S&&(yield e.recordError(this))}}}))}addSync(e){if(this.shouldRecord(b.uploadEnabled)){M(e)&&(e=1);try{b.metricsDatabase.transform(this,this.transformFn(e))}catch(e){e instanceof S&&e.recordErrorSync(this)}}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue",qt)){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}var Xt;Jt=new WeakMap;class Zt extends At{constructor(e,t){super("event",e),this.allowedExtraKeys=t}record(e,t=U()){b.isPlatformSync()?this.recordSync(t,e):this.recordAsync(t,e)}recordAsync(e,t){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){yield this.recordUndispatched(t,e)}))))}recordUndispatched(e,t=U()){return n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{const n=new Bt({category:this.category,name:this.name,timestamp:t,extra:e});let r;if(e&&this.allowedExtraKeys){r={};for(const[t,n]of Object.entries(e))this.allowedExtraKeys.includes(t)?x(n)?r[t]=yield k(this,n,100):r[t]=n:yield b.errorManager.record(this,i.InvalidValue,`Invalid key index: ${t}`)}return n.set(Object.assign(Object.assign({},n.get()),{extra:r})),b.eventsDatabase.record(this,n)}catch(e){e instanceof S&&(yield e.recordError(this))}}))}recordSync(e,t){if(this.shouldRecord(b.uploadEnabled))try{const n=new Bt({category:this.category,name:this.name,timestamp:e,extra:t});let r;if(t&&this.allowedExtraKeys){r={};for(const[e,n]of Object.entries(t))this.allowedExtraKeys.includes(e)?x(n)?r[e]=N(this,n,100):r[e]=n:b.errorManager.record(this,i.InvalidValue,`Invalid key index: ${e}`)}n.set(Object.assign(Object.assign({},n.get()),{extra:r})),b.eventsDatabase.record(this,n)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.EventMetricType")){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.eventsDatabase.getEvents(e,this)})))),t}}))}}Xt=new WeakMap;const Yt="core.Metric.EventsDatabase";function ei(e){x(e)||(e="");const t=new Date(e);if(isNaN(t.getTime()))throw new Error(`Error attempting to generate Date object from string: ${e}`);return t}function ti(e){return new Kt(Object.assign(Object.assign({},{category:"glean",name:`${Se}${"execution_counter"}`}),{sendInPings:e.filter((e=>e!==re)),lifetime:"ping",disabled:!1}))}function ii(e){return new Zt({category:"glean",name:"restarted",sendInPings:e.filter((e=>e!==re)),lifetime:"ping",disabled:!1},[se])}function ni(e){var t,i;return!!(null===(i=null===(t=null==e?void 0:e.get())||void 0===t?void 0:t.extra)||void 0===i?void 0:i[se])}function ri(e,t=b.startTime){return n(this,void 0,void 0,(function*(){const i=ii(e);yield i.recordUndispatched({[se]:t.toISOString()},0)}))}const si=class{constructor(){this.initialized=!1,this.eventsStore=new b.platform.Storage("events")}initialize(){var e;return n(this,void 0,void 0,(function*(){if(this.initialized)return;const t=yield this.getAvailableStoreNames();if(t.includes(re)){(null!==(e=yield this.eventsStore.get([re]))&&void 0!==e?e:[]).length>0&&(yield b.corePings.events.submitUndispatched("startup"))}yield ti(t).addUndispatched(1),yield ri(t),this.initialized=!0}))}record(e,t){return n(this,void 0,void 0,(function*(){if(!e.disabled)for(const i of e.sendInPings){const e=ti([i]);let n=yield b.metricsDatabase.getMetric(i,e);n||(yield e.addUndispatched(1),n=1,yield ri([i],new Date)),t.addExtra(ae,n);let r=0;const s=e=>{var i;const n=null!==(i=e)&&void 0!==i?i:[];return n.push(t.get()),r=n.length,n};yield this.eventsStore.update([i],s),i===re&&r>=b.config.maxEvents&&(yield b.corePings.events.submitUndispatched("max_capacity"))}}))}getEvents(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(0!==i.length)return i.filter((e=>e.get().category===t.category&&e.get().name===t.name)).map((e=>e.withoutReservedExtras()))}))}getPingEvents(e,t){return n(this,void 0,void 0,(function*(){const i=yield this.getAndValidatePingData(e);if(t&&Object.keys(i).length>0&&(yield this.eventsStore.delete([e])),0===i.length)return;const n=yield this.prepareEventsPayload(e,i);return n.length>0?n:void 0}))}clearAll(){return n(this,void 0,void 0,(function*(){yield this.eventsStore.delete([])}))}getAvailableStoreNames(){return n(this,void 0,void 0,(function*(){const e=yield this.eventsStore.get([]);return M(e)?[]:Object.keys(e)}))}getAndValidatePingData(e){return n(this,void 0,void 0,(function*(){const t=yield this.eventsStore.get([e]);return M(t)?[]:Array.isArray(t)?t.reduce(((e,t)=>{try{const i=new Bt(t);return[...e,i]}catch(i){return o(Yt,`Unexpected data found in events storage: ${JSON.stringify(t)}. Ignoring.`),e}}),[]):(o(Yt,`Unexpected value found for ping ${e}: ${JSON.stringify(t)}. Clearing.`,r.Error),yield this.eventsStore.delete([e]),[])}))}prepareEventsPayload(e,t){var r,s,a,o;return n(this,void 0,void 0,(function*(){let n,c=t.sort(((e,t)=>{var i,n;const r=Number(null===(i=e.get().extra)||void 0===i?void 0:i[ae]),s=Number(null===(n=t.get().extra)||void 0===n?void 0:n[ae]);return r!==s?r-s:e.get().timestamp-t.get().timestamp}));try{n=ei(null===(r=c[0].get().extra)||void 0===r?void 0:r[se]),c.shift()}catch(e){n=b.startTime}const d=(null===(s=c[0])||void 0===s?void 0:s.get().timestamp)||0;let u=0;for(const[t,r]of c.entries()){try{const s=ei(null===(a=r.get().extra)||void 0===a?void 0:a[se]),o=s.getTime()-n.getTime();n=s;const d=u+o,l=c[t-1].get().timestamp;d<=l?(u=l+1,yield b.errorManager.record(ii([e]),i.InvalidValue,`Invalid time offset between application sessions found for ping "${e}". Ignoring.`)):u=d}catch(e){}let s;s=1===Number((null===(o=r.get().extra)||void 0===o?void 0:o[ae])||1)?r.get().timestamp-d:r.get().timestamp+u,c[t]=new Bt({category:r.get().category,name:r.get().name,timestamp:s,extra:r.get().extra})}return c=function(e){for(;e.length&&ni(e[e.length-1]);)e.pop();return e}(c),c.map((e=>e.payload()))}))}},ai="core.Pings.Maker";function oi(e,t){return`/submit/${b.applicationId}/${t.name}/${Z}/${e}`}function ci(){const e={};if(b.config.debugViewTag&&(e["X-Debug-ID"]=b.config.debugViewTag),b.config.sourceTags&&(e["X-Source-Tags"]=b.config.sourceTags.toString()),Object.keys(e).length>0)return e}function di(e){return n(this,void 0,void 0,(function*(){const{startTimeMetric:t,startTime:i}=yield function(e){return n(this,void 0,void 0,(function*(){const t=new jt({category:"",name:`${e.name}#start`,sendInPings:[ee],lifetime:"user",disabled:!1},Vt.Minute),i=yield b.metricsDatabase.getMetric(ee,t);let n;return n=i?new _t(i):_t.fromDate(b.startTime,Vt.Minute),{startTimeMetric:t,startTime:n}}))}(e),r=new Date;yield t.setUndispatched(r);const s=_t.fromDate(r,Vt.Minute);return{startTime:i.payload(),endTime:s.payload()}}))}function ui(e,t){return n(this,void 0,void 0,(function*(){const i=yield function(e){return n(this,void 0,void 0,(function*(){const t=new Kt({category:"",name:`${e.name}#sequence`,sendInPings:[ee],lifetime:"user",disabled:!1}),i=yield b.metricsDatabase.getMetric(ee,t);if(yield t.addUndispatched(1),i)try{return new Ht(i).payload()}catch(t){o(ai,`Unexpected value found for sequence number in ping ${e.name}. Ignoring.`,r.Warn)}return 0}))}(e),{startTime:s,endTime:a}=yield di(e),c={seq:i,start_time:s,end_time:a};return t&&(c.reason=t),c}))}function li(e,t){return n(this,void 0,void 0,(function*(){const i=yield b.eventsDatabase.getPingEvents(e.name,!0),s=yield b.metricsDatabase.getPingMetrics(e.name,!0);if(!s&&!i){if(!e.sendIfEmpty)return void o(ai,`Storage for ${e.name} empty. Bailing out.`,r.Info);o(ai,`Storage for ${e.name} empty. Ping will still be sent.`,r.Info)}const a=s?{metrics:s}:{},c=i?{events:i}:{},d=yield ui(e,t),u=yield function(e){return n(this,void 0,void 0,(function*(){let t=yield b.metricsDatabase.getPingMetrics(te,!0);t||(o(ai,"Empty client info data. Will submit anyways.",r.Warn),t={});let i={telemetry_sdk_build:Y};for(const e in t)i=Object.assign(Object.assign({},i),t[e]);return e.includeClientId||delete i.client_id,i}))}(e);return Object.assign(Object.assign(Object.assign({},a),c),{ping_info:d,client_info:u})}))}const hi=function(e,t,i){return n(this,void 0,void 0,(function*(){const n=yield li(t,i);if(!n)return;let s;try{s=yield Q.afterPingCollection.trigger(n)}catch(e){return void o(ai,[`Error while attempting to modify ping payload for the "${t.name}" ping using`,`the ${JSON.stringify(Q.afterPingCollection.registeredPluginIdentifier)} plugin.`,"Ping will not be submitted. See more logs below.\n\n",e],r.Error)}b.config.logPings&&o(ai,JSON.stringify(n,null,2),r.Info);const a=s||n,c=ci();return b.pingsDatabase.recordPing(oi(e,t),e,a,c)}))},fi={afterPingCollection:new K("afterPingCollection")};function gi(e){const{startTimeMetric:t,startTime:i}=function(e){const t=new jt({category:"",name:`${e.name}#start`,sendInPings:[ee],lifetime:"user",disabled:!1},Vt.Minute),i=b.metricsDatabase.getMetric(ee,t);let n;return n=i?new _t(i):_t.fromDate(b.startTime,Vt.Minute),{startTimeMetric:t,startTime:n}}(e),n=new Date;t.set(n);const r=_t.fromDate(n,Vt.Minute);return{startTime:i.payload(),endTime:r.payload()}}function mi(e,t){const i=function(e){const t=new Kt({category:"",name:`${e.name}#sequence`,sendInPings:[ee],lifetime:"user",disabled:!1}),i=b.metricsDatabase.getMetric(ee,t);if(t.add(1),i)try{return new Ht(i).payload()}catch(t){o(ai,`Unexpected value found for sequence number in ping ${e.name}. Ignoring.`,r.Warn)}return 0}(e),{startTime:n,endTime:s}=gi(e),a={seq:i,start_time:n,end_time:s};return t&&(a.reason=t),a}function pi(e,t){const i=b.eventsDatabase.getPingEvents(e.name,!0),n=b.metricsDatabase.getPingMetrics(e.name,!0);if(!n&&!i){if(!e.sendIfEmpty)return void o(ai,`Storage for ${e.name} empty. Bailing out.`,r.Info);o(ai,`Storage for ${e.name} empty. Ping will still be sent.`,r.Info)}const s=n?{metrics:n}:{},a=i?{events:i}:{},c=mi(e,t),d=function(e){let t=b.metricsDatabase.getPingMetrics(te,!0);t||(o(ai,"Empty client info data. Will submit anyways.",r.Warn),t={});let i={telemetry_sdk_build:Y};for(const e in t)i=Object.assign(Object.assign({},i),t[e]);return e.includeClientId||delete i.client_id,i}(e);return Object.assign(Object.assign(Object.assign({},s),a),{ping_info:c,client_info:d})}const yi=function(e,t,i){const n=pi(t,i);if(!n)return;let s;try{s=fi.afterPingCollection.trigger(n)}catch(e){return void o(ai,[`Error while attempting to modify ping payload for the "${t.name}" ping using`,`the ${JSON.stringify(fi.afterPingCollection.registeredPluginIdentifier)} plugin.`,"Ping will not be submitted. See more logs below.\n\n",e],r.Error)}b.config.logPings&&o(ai,JSON.stringify(n,null,2),r.Info);const a=s||n,c=ci();b.pingsDatabase.recordPing(oi(e,t),e,a,c)};var vi;const bi="core.Pings.PingType";function wi(e){return e===ne}class Si{constructor(e){var t;this.name=e.name,this.includeClientId=e.includeClientId,this.sendIfEmpty=e.sendIfEmpty,this.reasonCodes=null!==(t=e.reasonCodes)&&void 0!==t?t:[]}submit(e){b.isPlatformSync()?this.submitSync(e):this.submitAsync(e)}submitAsync(e){this.testCallback?this.testCallback(e).then((()=>{this.internalSubmit(e,this.resolveTestPromiseFunction)})).catch((t=>{o(bi,[`There was an error validating "${this.name}" (${null!=e?e:"no reason"}):`,t],r.Error),this.internalSubmit(e,this.rejectTestPromiseFunction)})):this.internalSubmit(e)}internalSubmit(e,t){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){yield this.submitUndispatched(e,t)}))))}submitUndispatched(e,t){return n(this,void 0,void 0,(function*(){if(!b.initialized)return void o(bi,"Glean must be initialized before submitting pings.",r.Info);if(!b.uploadEnabled&&!wi(this.name))return void o(bi,"Glean disabled: not submitting pings. Glean may still submit the deletion-request ping.",r.Info);let i=e;e&&!this.reasonCodes.includes(e)&&(o(bi,`Invalid reason code ${e} from ${this.name}. Ignoring.`,r.Warn),i=void 0);const n=R();yield hi(n,this,i),t&&(t(),this.resolveTestPromiseFunction=void 0,this.rejectTestPromiseFunction=void 0,this.testCallback=void 0)}))}submitSync(e){this.testCallback?this.testCallback(e).then((()=>{this.internalSubmitSync(e,this.resolveTestPromiseFunction)})).catch((t=>{o(bi,[`There was an error validating "${this.name}" (${null!=e?e:"no reason"}):`,t],r.Error),this.internalSubmitSync(e,this.rejectTestPromiseFunction)})):this.internalSubmitSync(e)}internalSubmitSync(e,t){if(!b.initialized)return void o(bi,"Glean must be initialized before submitting pings.",r.Info);if(!b.uploadEnabled&&!wi(this.name))return void o(bi,"Glean disabled: not submitting pings. Glean may still submit the deletion-request ping.",r.Info);let i=e;e&&!this.reasonCodes.includes(e)&&(o(bi,`Invalid reason code ${e} from ${this.name}. Ignoring.`,r.Warn),i=void 0);const n=R();yi(n,this,i),t&&(t(),this.resolveTestPromiseFunction=void 0,this.rejectTestPromiseFunction=void 0,this.testCallback=void 0)}testBeforeNextSubmit(e){return n(this,void 0,void 0,(function*(){if(O("testBeforeNextSubmit",bi))return this.testCallback?void o(bi,`There is an existing test call for ping "${this.name}". Ignoring.`,r.Error):new Promise(((t,i)=>{this.resolveTestPromiseFunction=t,this.rejectTestPromiseFunction=i,this.testCallback=e}))}))}}vi=new WeakMap;const Ei=class{constructor(){this.deletionRequest=new Si({name:ne,includeClientId:!0,sendIfEmpty:!0,reasonCodes:["at_init","set_upload_enabled"]}),this.events=new Si({name:re,includeClientId:!0,sendIfEmpty:!1,reasonCodes:["startup","max_capacity"]})}};function Ti(e,t){const i=function(e){return e.split("/")[0]}(e.baseIdentifier());return new Kt({name:fe(t,i),category:"glean.error",lifetime:"ping",sendInPings:e.sendInPings,disabled:!1})}class Ii{record(e,t,i,r=1){return n(this,void 0,void 0,(function*(){const n=Ti(e,t);o(function(e){return`core.metrics.${e.type.charAt(0).toUpperCase()+e.type.slice(1)}`}(e),[`${e.baseIdentifier()}:`,i]),r>0&&(yield n.addUndispatched(r))}))}testGetNumRecordedErrors(e,t,i){return n(this,void 0,void 0,(function*(){const n=Ti(e,t);return(yield n.testGetValue(i))||0}))}}const Mi="core.Glean";var xi;!function(e){function t(){return n(this,void 0,void 0,(function*(){b.uploadEnabled=!0,yield b.coreMetrics.initialize()}))}function i(e){return n(this,void 0,void 0,(function*(){let t;t=e?"at_init":"set_upload_enabled",b.uploadEnabled=!1,yield b.corePings.deletionRequest.submitUndispatched(t),yield s()}))}function s(){return n(this,void 0,void 0,(function*(){let t;yield e.pingUploader.clearPendingPingsQueue();try{t=new _t(yield b.metricsDatabase.getMetric(te,b.coreMetrics.firstRunDate)).date}catch(e){t=new Date}yield b.eventsDatabase.clearAll(),yield b.metricsDatabase.clearAll(),yield b.pingsDatabase.clearAll(),b.uploadEnabled=!0,yield b.coreMetrics.clientId.setUndispatched(ie),yield b.coreMetrics.firstRunDate.setUndispatched(t),b.uploadEnabled=!1}))}e.initialize=function(a,c,d){if(b.initialized)return void o(Mi,"Attempted to initialize Glean, but it has already been initialized. Ignoring.",r.Warn);if(!x(a))return void o(Mi,"Unable to initialize Glean, applicationId must be a string.",r.Error);if(!P(c))return void o(Mi,"Unable to initialize Glean, uploadEnabled must be a boolean.",r.Error);if(0===a.length)return void o(Mi,"Unable to initialize Glean, applicationId cannot be an empty string.",r.Error);if(!b.platform)return void o(Mi,"Unable to initialize Glean, platform has not been set.",r.Error);b.coreMetrics=new Wt,b.corePings=new Ei,b.applicationId=function(e){return e.replace(/[^a-z0-9]+/gi,"-").toLowerCase()}(a);const u=new de(d);if(b.config=u,e.preInitLogPings&&(b.config.logPings=e.preInitLogPings),e.preInitDebugViewTag&&(b.config.debugViewTag=e.preInitDebugViewTag),e.preInitSourceTags&&(b.config.sourceTags=e.preInitSourceTags),b.metricsDatabase=new Te,b.eventsDatabase=new si,b.pingsDatabase=new yt,b.errorManager=new Ii,e.pingUploader=new $t(u,b.pingsDatabase),null==d?void 0:d.plugins)for(const e of d.plugins)X(e);b.dispatcher.flushInit((()=>n(this,void 0,void 0,(function*(){if(b.initialized=!0,b.uploadEnabled=c,yield b.eventsDatabase.initialize(),c)yield b.metricsDatabase.clear("application"),yield t();else{const e=yield b.metricsDatabase.getMetric(te,b.coreMetrics.clientId);e?e!==ie&&(yield i(!0)):yield s()}yield b.pingsDatabase.scanPendingPings()}))))},e.setUploadEnabled=function(e){b.initialized?P(e)?b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){b.uploadEnabled!==e&&(e?yield t():yield i(!1))})))):o(Mi,"Unable to change upload state, new value must be a boolean. Ignoring.",r.Error):o(Mi,["Changing upload enabled before Glean is initialized is not supported.\n","Pass the correct state into `initialize`.\n","See documentation at https://mozilla.github.io/glean/book/user/general-api.html#initializing-the-glean-sdk`"],r.Error)},e.setLogPings=function(t){b.initialized?b.dispatcher.launch((()=>(b.config.logPings=t,Promise.resolve()))):e.preInitLogPings=t},e.setDebugViewTag=function(t){b.initialized?b.dispatcher.launch((()=>(b.config.debugViewTag=t,Promise.resolve()))):e.preInitDebugViewTag=t},e.setSourceTags=function(t){b.initialized?b.dispatcher.launch((()=>(b.config.sourceTags=t,Promise.resolve()))):e.preInitSourceTags=t},e.shutdown=function(){return n(this,void 0,void 0,(function*(){b.initialized?(yield b.dispatcher.shutdown(),yield e.pingUploader.blockOnOngoingUploads()):o(Mi,"Attempted to shutdown Glean, but Glean is not initialized. Ignoring.")}))},e.setPlatform=function(e){b.initialized||(b.isPlatformSet()&&b.platform.name!==e.name&&!b.testing&&o(Mi,[`IMPOSSIBLE: Attempted to change Glean's targeted platform",\n           "from "${b.platform.name}" to "${e.name}". Ignoring.`],r.Error),b.platform=e)}}(xi||(xi={}));const Pi=xi;function Di(e=!0){return n(this,void 0,void 0,(function*(){b.initialized&&(yield Pi.shutdown(),e&&(yield b.eventsDatabase.clearAll(),yield b.metricsDatabase.clearAll(),yield b.pingsDatabase.clearAll()),b.testUninitialize(),function(){for(const e in Q)Q[e].deregisterPlugin()}(),Pi.preInitLogPings=void 0,Pi.preInitDebugViewTag=void 0,Pi.preInitSourceTags=void 0)}))}const $i="platform.qt.Uploader";const Ai=new class extends W{post(e,t,i={}){return n(this,void 0,void 0,(function*(){return new Promise((n=>{const s=new XMLHttpRequest;s.timeout=1e4,s.open("POST",e);for(const e in i)s.setRequestHeader(e,i[e]);s.ontimeout=function(e){o($i,["Timeout while attempting to upload ping.\n",e.type],r.Error),n(new F(0))},s.onerror=function(e){o($i,["Network error while attempting to upload ping.\n",e.type],r.Error),n(new F(0))},s.onabort=function(e){o($i,["The attempt to upload ping is aborted.\n",e.type],r.Error),n(new F(0))},s.onload=()=>{n(new F(2,s.status))},x(t)?s.send(t):s.send(t.buffer)}))}))}},Ri={os(){return n(this,void 0,void 0,(function*(){switch(Qt.platform.os){case"android":return"Android";case"ios":return"iOS";case"tvos":return"TvOS";case"linux":return"Linux";case"osx":return"Darwin";case"qnx":return"QNX";case"windows":case"winrt":return"Windows";case"wasm":return"Wasm";default:return"Unknown"}}))},osVersion(e){return n(this,void 0,void 0,(function*(){return Promise.resolve(e||"Unknown")}))},arch(e){return n(this,void 0,void 0,(function*(){return Promise.resolve(e||"Unknown")}))},locale(){return n(this,void 0,void 0,(function*(){const e=Qt.locale();return Promise.resolve(e?e.name.replace("_","-"):"und")}))}};function Ui(e,t="",i=[]){if(I(e)){const n=Object.keys(e);for(const r of n){const n=e[r];M(n)||Ui(n,`${t}${r}+`,i)}}else i.push([t.slice(0,-1),JSON.stringify(e)]);return i}function ki(e){if(!e||0===e.rows.length)return;const t={};for(let i=0;i<e.rows.length;i++){const n=e.rows.item(i),r=n.key.split("+");let s=t;for(const e of r.slice(0,-1))M(s[e])&&(s[e]={}),s=s[e];try{s[r[r.length-1]]=JSON.parse(n.value)}catch(e){s[r[r.length-1]]=n.value}}return t}const Ni={Storage:class{constructor(e,t="Glean"){this.tableName=e,this.name=t;const i=`platform.qt.Storage.${e}`;this.initialized=this.executeQuery(`CREATE TABLE IF NOT EXISTS ${e}(key VARCHAR(255), value VARCHAR(255));`,i),this.logTag=i}createKeyFromIndex(e){return e.join("+")}getDbHandle(e){try{const e=LocalStorage.LocalStorage.openDatabaseSync(this.name,"1.0",`${this.name} Storage`,3e5);this.dbHandle=e}catch(t){o(e||this.logTag,["Error while attempting to access LocalStorage.\n",t],r.Debug)}finally{return this.dbHandle}}executeQuery(e,t){const i=this.getDbHandle(t);return i?new Promise(((n,s)=>{try{i.transaction((t=>{const i=t.executeSql(e);n(i)}))}catch(i){o(t||this.logTag,[`Error executing LocalStorage query: ${e}.\n`,i],r.Debug),s()}})):Promise.reject()}executeOnceInitialized(e){return n(this,void 0,void 0,(function*(){return yield this.initialized,this.executeQuery(e)}))}getFullResultObject(e){return n(this,void 0,void 0,(function*(){const t=this.createKeyFromIndex(e);return ki(yield this.executeOnceInitialized(`SELECT * FROM ${this.tableName} WHERE key LIKE "${t}%"`))}))}getWholeStore(){return n(this,void 0,void 0,(function*(){return ki(yield this.executeOnceInitialized(`SELECT * FROM ${this.tableName}`))}))}get(e=[]){return n(this,void 0,void 0,(function*(){if(0===e.length)return this.getWholeStore();const t=(yield this.getFullResultObject(e))||{};try{return C(t,e)}catch(e){o(this.logTag,["Error getting value from database.",e])}}))}update(e,t){return n(this,void 0,void 0,(function*(){const i=Ui(_((yield this.getFullResultObject(e))||{},e,t));for(const e of i){const[t,i]=e,n=i.replace("'","''"),r=yield this.executeOnceInitialized(`UPDATE ${this.tableName} SET value='${n}' WHERE key='${t}'`);(null==r?void 0:r.rows.length)||(yield this.executeOnceInitialized(`INSERT INTO ${this.tableName}(key, value) VALUES('${t}', '${n}');`))}}))}delete(e){return n(this,void 0,void 0,(function*(){const t=this.createKeyFromIndex(e);yield this.executeOnceInitialized(`DELETE FROM ${this.tableName} WHERE key LIKE "${t}%"`)}))}},uploader:Ai,info:Ri,timer:{setTimeout:()=>{throw new Error},clearTimeout:()=>{}},name:"Qt"};var Oi;class Gi extends E{constructor(e){super(e)}validate(e){return P(e)?{type:w.Success}:{type:w.Error,errorMessage:`Expected boolean value, got ${JSON.stringify(e)}`}}payload(){return this.inner}}class Vi extends At{constructor(e){super("boolean",e,Gi)}set(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}setAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{const t=new Gi(e);yield b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}setSync(e){if(this.shouldRecord(b.uploadEnabled))try{const t=new Gi(e);b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.BooleanMetricType")){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}var Ci,_i;Oi=new WeakMap,function(e){e.linear="linear",e.exponential="exponential"}(Ci||(Ci={}));class ji{constructor(e){this.values={},this.count=0,this.sum=0,this.bucketing=e}bucketCount(){return Object.keys(this.values).length}accumulate(e){const t=this.bucketing.sampleToBucketMinimum(e);this.values[t]||(this.values[t]=0),this.values[t]=this.values[t]+1,this.sum=G(this.sum,e),this.count+=1}isEmpty(){return 0===this.count}snapshotValues(){return this.bucketing.snapshotOverride?this.bucketing.snapshotOverride(this.values):this.getDefaultSnapshot()}getDefaultSnapshot(){const e=Object.assign({},this.values),t=Object.keys(e).reduce(((e,t)=>{const i=Number(e);return Number(t)>i?t:e})),i=this.bucketing.ranges();for(const n of i)if(e[n]||(e[n]=0),n>Number(t))break;return e}}function zi(e,t){let i=0,n=e.length-1,r=-1;for(;i<=n;){if(r=Math.floor((i+n)/2),e[r]===t)return r;t<e[r]?n=r-1:i=r+1}return r-i>n-r?r-1:r}class Li{constructor(e,t,i){this.min=e,this.max=t,this.bucketCount=i,this.bucketRanges=[]}sampleToBucketMinimum(e){const t=zi(this.ranges(),e);if(-1===t)throw new Error("Unable to find correct bucket for the sample.");return this.ranges()[t]}ranges(){return this.bucketRanges.length||(this.bucketRanges=function(e,t,i){const n=Math.log(t),r=[];let s=e;0===s&&(s=1),r.push(0),r.push(s);for(let e=2;e<i;e++){const t=Math.log(s),a=t+(n-t)/(i-e),o=Math.round(Math.exp(a));o>s?s=o:s+=1,r.push(s)}return r}(this.min,this.max,this.bucketCount)),this.bucketRanges}}class Fi{constructor(e,t,i){this.min=e,this.max=t,this.bucketCount=i,this.bucketRanges=[]}sampleToBucketMinimum(e){const t=zi(this.ranges(),e);if(-1===t)throw new Error("Unable to find correct bucket for the sample.");return this.ranges()[t]}ranges(){return this.bucketRanges.length||(this.bucketRanges=function(e,t,i){const n=[];n.push(0);const r=Math.max(1,e);for(let e=1;e<i;e++){const s=(r*(i-1-e)+t*(e-1))/(i-2);n.push(Math.floor(s))}return n}(this.min,this.max,this.bucketCount)),this.bucketRanges}}function Wi(e){const t=e.snapshotValues(),i={};return Object.entries(t).forEach((([e,t])=>{const n=Number(e);t>0&&!isNaN(n)&&(i[n]=t)})),{count:e.count,values:i,sum:e.sum}}function Bi(e){let t;return t=e||[],t}function Ji(e){return e.filter((e=>e<0)).length}function qi(e,t){return e.filter((e=>e>t)).length}class Hi extends E{constructor(e){super(e)}get customDistribution(){return this.inner}validate(e){const t=e;return M(t)?{type:w.Error,errorType:i.InvalidType,errorMessage:`Expected valid CustomDistribution object, got ${JSON.stringify(t)}`}:M(t.bucketCount)||t.bucketCount<0?{type:w.Error,errorType:i.InvalidValue,errorMessage:`Expected bucket count to be greater than 0, got ${t.bucketCount}`}:M(t.rangeMin)||t.rangeMin<0?{type:w.Error,errorType:i.InvalidValue,errorMessage:`Expected histogram rangeMin to be greater than 0, got ${t.rangeMin}`}:M(t.rangeMax)||t.rangeMax<0?{type:w.Error,errorType:i.InvalidValue,errorMessage:`Expected histogram rangeMax to be greater than 0, got ${t.rangeMax}`}:M(t.histogramType)||!(t.histogramType in Ci)?{type:w.Error,errorType:i.InvalidValue,errorMessage:`Expected histogram type to be either Linear or Exponential, got ${t.histogramType}`}:{type:w.Success}}payload(){const{bucketCount:e,histogramType:t,rangeMax:i,rangeMin:n,values:r}=this.inner,s=Qi(r,n,i,e,t);return{sum:s.sum,values:s.values}}}class Ki extends At{constructor(e,t,i,n,r){super("custom_distribution",e,Hi),this.rangeMin=t,this.rangeMax=i,this.bucketCount=n,this.histogramType=r}accumulateSamples(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}transformFn(e){return t=>{const i=Bi(t),n=[];return e.forEach((e=>{e>=0&&n.push(e)})),new Hi({values:[...i,...n],rangeMin:this.rangeMin,rangeMax:this.rangeMax,bucketCount:this.bucketCount,histogramType:this.histogramType})}}setAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{yield b.metricsDatabase.transform(this,this.transformFn(e));const t=Ji(e);t>0&&(yield b.errorManager.record(this,i.InvalidValue,`Accumulated ${t} negative samples`,t))}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}setSync(e){if(this.shouldRecord(b.uploadEnabled))try{b.metricsDatabase.transform(this,this.transformFn(e));const t=Ji(e);t>0&&b.errorManager.record(this,i.InvalidValue,`Accumulated ${t} negative samples`,t)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.CustomDistributionMetricType")){let t;if(yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t){const{bucketCount:e,histogramType:i,rangeMax:n,rangeMin:r,values:s}=t;return Wi(Qi(s,r,n,e,i))}}}))}}function Qi(e,t,i,n,r){switch(r){case Ci.exponential:return function(e=[],t,i,n){const r=new ji(new Li(t,i,n));return e.forEach((e=>{r.accumulate(e)})),r}(e,t,i,n);case Ci.linear:return function(e=[],t,i,n){const r=new ji(new Fi(t,i,n));return e.forEach((e=>{r.accumulate(e)})),r}(e,t,i,n)}}_i=new WeakMap;class Xi{constructor(e,t){this.exponent=Math.pow(e,1/t)}sampleToBucketMinimum(e){if(0===e)return 0;const t=this.sampleToBucketIndex(e);return this.bucketIndexToBucketMinimum(t)}ranges(){throw new Error("Bucket ranges for functional bucketing are not precomputed")}sampleToBucketIndex(e){return Math.floor(Math.log(G(e,1))/Math.log(this.exponent))}bucketIndexToBucketMinimum(e){return Math.floor(Math.pow(this.exponent,e))}snapshotOverride(e){if(!Object.keys(e).length)return{};let t=Number.MAX_VALUE,i=Number.MIN_VALUE;Object.keys(e).forEach((e=>{const n=Number(e);(null===t||n<t)&&(t=n),(null==i||n>i)&&(i=n)}));const n=this.sampleToBucketIndex(t),r=this.sampleToBucketIndex(i);for(let t=n;t<r;t++){const i=this.bucketIndexToBucketMinimum(t);e[i]||(e[i]=0)}return e}}function Zi(e=[],t,i){const n=new ji(new Xi(t,i));return e.forEach((e=>{n.accumulate(e)})),n}var Yi,en;function tn(e,t){switch(t){case Yi.Byte:return e;case Yi.Kilobyte:return 1024*e;case Yi.Megabyte:return e*2**20;case Yi.Gigabyte:return e*2**30}}!function(e){e.Byte="byte",e.Kilobyte="kilobyte",e.Megabyte="megabyte",e.Gigabyte="gigabyte"}(Yi||(Yi={}));const nn=2**40;class rn extends E{constructor(e){super(e)}get memoryDistribution(){return this.inner}validate(e){if(M(e)||!Array.isArray(e))return{type:w.Error,errorType:i.InvalidType,errorMessage:`Expected valid MemoryDistribution object, got ${JSON.stringify(e)}`};const t=e.find((e=>e<0));return t?{type:w.Error,errorType:i.InvalidValue,errorMessage:`Expected all samples to be greater than 0, got ${t}`}:{type:w.Success}}payload(){const e=Zi(this.inner,2,16);return{values:e.values,sum:e.sum}}}class sn extends At{constructor(e,t){super("memory_distribution",e,rn),this.memoryUnit=t}accumulate(e){b.isPlatformSync()?this.accumulateSync(e):this.accumulateAsync(e)}accumulateTransformFn(e){return t=>{const i=Bi(t);return new rn([...i,e])}}accumulateSamples(e){b.isPlatformSync()?this.accumulateSamplesSync(e):this.accumulateSamplesAsync(e)}accumulateSamplesTransformFn(e){return t=>{const i=Bi(t),n=[];return e.forEach((e=>{e>=0&&((e=tn(e,this.memoryUnit))>nn&&(e=nn),n.push(e))})),new rn([...i,...n])}}accumulateAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;if(e<0)return void(yield b.errorManager.record(this,i.InvalidValue,"Accumulated a negative sample"));let t=tn(e,this.memoryUnit);e>nn&&(yield b.errorManager.record(this,i.InvalidValue,"Sample is bigger than 1 terabyte."),t=nn);try{yield b.metricsDatabase.transform(this,this.accumulateTransformFn(t))}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}accumulateSamplesAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;yield b.metricsDatabase.transform(this,this.accumulateSamplesTransformFn(e));const t=Ji(e);t>0&&(yield b.errorManager.record(this,i.InvalidValue,`Accumulated ${t} negative samples`,t));const n=qi(e,nn);n>0&&(yield b.errorManager.record(this,i.InvalidValue,`Accumulated ${n} larger than 1TB`,n))}))))}accumulateSync(e){if(!this.shouldRecord(b.uploadEnabled))return;if(e<0)return void b.errorManager.record(this,i.InvalidValue,"Accumulated a negative sample");let t=tn(e,this.memoryUnit);e>nn&&(b.errorManager.record(this,i.InvalidValue,"Sample is bigger than 1 terabyte."),t=nn);try{b.metricsDatabase.transform(this,this.accumulateTransformFn(t))}catch(e){e instanceof S&&e.recordErrorSync(this)}}accumulateSamplesSync(e){if(!this.shouldRecord(b.uploadEnabled))return;b.metricsDatabase.transform(this,this.accumulateSamplesTransformFn(e));const t=Ji(e);t>0&&b.errorManager.record(this,i.InvalidValue,`Accumulated ${t} negative samples`,t);const n=qi(e,nn);n>0&&b.errorManager.record(this,i.InvalidValue,`Accumulated ${n} larger than 1TB`,n)}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.MemoryDistributionMetricType")){let t;if(yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t)return Wi(Zi(t,2,16))}}))}testGetNumRecordedErrors(e,t=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){return O("testGetNumRecordedErrors")?b.errorManager.testGetNumRecordedErrors(this,e,t):0}))}}var an;en=new WeakMap;class on extends E{constructor(e){super(e)}validate(e){return ve(e)}payload(){return this.inner}}class cn extends At{constructor(e){super("quantity",e,on)}set(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}setAsync(e){b.dispatcher.launch((()=>this.setUndispatched(e)))}setUndispatched(e){return n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))if(e<0)yield b.errorManager.record(this,i.InvalidValue,`Set negative value ${e}`);else{e>Number.MAX_SAFE_INTEGER&&(e=Number.MAX_SAFE_INTEGER);try{const t=new on(e);yield b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&(yield e.recordError(this))}}}))}setSync(e){if(this.shouldRecord(b.uploadEnabled))if(e<0)b.errorManager.record(this,i.InvalidValue,`Set negative value ${e}`);else{e>Number.MAX_SAFE_INTEGER&&(e=Number.MAX_SAFE_INTEGER);try{const t=new on(e);b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&e.recordErrorSync(this)}}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.QuantityMetricType")){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}var dn;an=new WeakMap;const un="core.metrics.RateMetricType";class ln extends E{constructor(e){super(e)}get numerator(){return this.inner.numerator}get denominator(){return this.inner.denominator}validate(e){if(!I(e)||2!==Object.keys(e).length)return{type:w.Error,errorMessage:`Expected Glean rate metric object, got ${JSON.stringify(e)}`};const t=ve(e.numerator);if(t.type===w.Error)return t;const i=ve(e.denominator);return i.type===w.Error?i:{type:w.Success}}payload(){return this.inner}}class hn extends At{constructor(e){super("rate",e,ln)}addToNumerator(e){this.add({denominator:0,numerator:e})}addToDenominator(e){this.add({numerator:0,denominator:e})}add(e){b.isPlatformSync()?this.addSync(e):this.addAsync(e)}transformFn(e){return t=>{const i=new ln(e);if(t)try{const e=new ln(t);i.set({numerator:G(i.numerator,e.numerator),denominator:G(i.denominator,e.denominator)})}catch(e){o(un,`Unexpected value found in storage for metric ${this.name}: ${JSON.stringify(t)}. Overwriting.`)}return i}}addAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{yield b.metricsDatabase.transform(this,this.transformFn(e))}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}addSync(e){if(this.shouldRecord(b.uploadEnabled))try{b.metricsDatabase.transform(this,this.transformFn(e))}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue",un)){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}var fn;dn=new WeakMap;const gn="core.metrics.StringListMetricType",mn=20;class pn extends E{constructor(e){super(e)}validate(e){if(!Array.isArray(e))return{type:w.Error,errorMessage:`Expected array, got ${JSON.stringify(e)}`};for(const t of e){const e=be(t);if(e.type===w.Error)return e}return{type:w.Success}}concat(e){const t=this.validateOrThrow(e),n=[...this.inner,...t];if(n.length>mn)throw new S(`String list length of ${n.length} would exceed maximum of 20.`,i.InvalidValue);this.inner=n}payload(){return this.inner}}class yn extends At{constructor(e){super("string_list",e,pn)}set(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}add(e){b.isPlatformSync()?this.addSync(e):this.addAsync(e)}addTransformFn(e){return t=>{const n=new pn([e]);try{t&&n.concat(t)}catch(e){if(e instanceof S&&e.type!==i.InvalidType)throw e;o(gn,`Unexpected value found in storage for metric ${this.name}: ${JSON.stringify(t)}. Overwriting.`)}return n}}setAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{e.length>mn&&(yield b.errorManager.record(this,i.InvalidValue,`String list length of ${e.length} exceeds maximum of 20.`));const t=new pn(e),n=[];for(let t=0;t<Math.min(e.length,mn);++t){const i=yield k(this,e[t],50);n.push(i)}t.set(n),yield b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}addAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{const t=yield k(this,e,50);yield b.metricsDatabase.transform(this,this.addTransformFn(t))}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}setSync(e){if(this.shouldRecord(b.uploadEnabled))try{e.length>mn&&b.errorManager.record(this,i.InvalidValue,`String list length of ${e.length} exceeds maximum of 20.`);const t=new pn(e),n=[];for(let t=0;t<Math.min(e.length,mn);++t){const i=N(this,e[t],50);n.push(i)}t.set(n),b.metricsDatabase.record(this,t)}catch(e){e instanceof S&&e.recordErrorSync(this)}}addSync(e){if(this.shouldRecord(b.uploadEnabled))try{const t=N(this,e,50);b.metricsDatabase.transform(this,this.addTransformFn(t))}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue",gn)){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}var vn;fn=new WeakMap;const bn=204800;class wn extends E{constructor(e){super(e)}validate(e){return be(e)}payload(){return this.inner}}class Sn extends At{constructor(e){super("text",e,wn)}set(e){b.isPlatformSync()?this.setSync(e):this.setAsync(e)}setAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled))try{const t=yield k(this,e,bn),i=new wn(t);yield b.metricsDatabase.record(this,i)}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}setSync(e){if(this.shouldRecord(b.uploadEnabled))try{const t=N(this,e,bn),i=new wn(t);b.metricsDatabase.record(this,i)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.TextMetricType")){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}var En;vn=new WeakMap;class Tn extends E{constructor(e){super(e)}get timespan(){switch(this.inner.timeUnit){case Vt.Nanosecond:return this.inner.timespan*10**6;case Vt.Microsecond:return 1e3*this.inner.timespan;case Vt.Millisecond:return this.inner.timespan;case Vt.Second:return Math.round(this.inner.timespan/1e3);case Vt.Minute:return Math.round(this.inner.timespan/1e3/60);case Vt.Hour:return Math.round(this.inner.timespan/1e3/60/60);case Vt.Day:return Math.round(this.inner.timespan/1e3/60/60/24)}}validateTimespan(e){return $(e)?e<0?{type:w.Error,errorMessage:`Expected positive value, got ${JSON.stringify(e)}`,errorType:i.InvalidValue}:{type:w.Success}:{type:w.Error,errorMessage:`Expected integer value, got ${JSON.stringify(e)}`}}validate(e){if(!I(e)||2!==Object.keys(e).length||!("timespan"in e)||!("timeUnit"in e))return{type:w.Error,errorMessage:`Expected timespan object, got ${JSON.stringify(e)}`};const t=this.validateTimespan(e.timespan);if(t.type===w.Error)return t;return"timeUnit"in e&&x(e.timeUnit)&&Object.values(Vt).includes(e.timeUnit)?{type:w.Success}:{type:w.Error,errorMessage:`Expected valid timeUnit for timespan, got ${JSON.stringify(e)}`}}payload(){return{time_unit:this.inner.timeUnit,value:this.timespan}}}class In extends At{constructor(e,t){super("timespan",e,Tn),this.timeUnit=t}start(){b.isPlatformSync()?this.startSync():this.startAsync()}stop(){b.isPlatformSync()?this.stopSync():this.stopAsync()}cancel(){b.isPlatformSync()?this.cancelSync():this.cancelAsync()}setRawNanos(e){b.isPlatformSync()?this.setRawNanosSync(e):this.setRawNanosAsync(e)}startAsync(){const e=U();b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(this.shouldRecord(b.uploadEnabled)){if(M(this.startTime))return this.startTime=e,Promise.resolve();yield b.errorManager.record(this,i.InvalidState,"Timespan already started")}}))))}stopAsync(){const e=U();b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return void(this.startTime=void 0);if(M(this.startTime))return void(yield b.errorManager.record(this,i.InvalidState,"Timespan not running."));const t=e-this.startTime;this.startTime=void 0,t<0?yield b.errorManager.record(this,i.InvalidState,"Timespan was negative."):yield this.setRawUndispatched(t)}))))}cancelAsync(){b.dispatcher.launch((()=>(this.startTime=void 0,Promise.resolve())))}setRawNanosAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){const t=e*10**-6;yield this.setRawUndispatched(t)}))))}setRawUndispatched(e){return n(this,void 0,void 0,(function*(){yield this.setRawAsync(e)}))}setRawAsync(e){return n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;if(!M(this.startTime))return void(yield b.errorManager.record(this,i.InvalidState,"Timespan already running. Raw value not recorded."));let t=!1;try{const i=(e=>i=>{let n;try{n=new Tn(i),t=!0}catch(t){n=new Tn({timespan:e,timeUnit:this.timeUnit})}return n})(e);yield b.metricsDatabase.transform(this,i)}catch(e){e instanceof S&&(yield e.recordError(this))}t&&(yield b.errorManager.record(this,i.InvalidState,"Timespan value already recorded. New value discarded."))}))}startSync(){const e=U();this.shouldRecord(b.uploadEnabled)&&(M(this.startTime)?this.startTime=e:b.errorManager.record(this,i.InvalidState,"Timespan already started"))}stopSync(){const e=U();if(!this.shouldRecord(b.uploadEnabled))return void(this.startTime=void 0);if(M(this.startTime))return void b.errorManager.record(this,i.InvalidState,"Timespan not running.");const t=e-this.startTime;this.startTime=void 0,t<0?b.errorManager.record(this,i.InvalidState,"Timespan was negative."):this.setRawSync(t)}cancelSync(){this.startTime=void 0}setRawNanosSync(e){const t=e*10**-6;this.setRawSync(t)}setRawSync(e){if(!this.shouldRecord(b.uploadEnabled))return;if(!M(this.startTime))return void b.errorManager.record(this,i.InvalidState,"Timespan already running. Raw value not recorded.");let t=!1;try{const i=(e=>i=>{let n;try{n=new Tn(i),t=!0}catch(t){n=new Tn({timespan:e,timeUnit:this.timeUnit})}return n})(e);b.metricsDatabase.transform(this,i)}catch(e){e instanceof S&&e.recordErrorSync(this)}t&&b.errorManager.record(this,i.InvalidState,"Timespan value already recorded. New value discarded.")}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.TimespanMetricType")){let t;if(yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t)return new Tn(t).timespan}}))}}var Mn;En=new WeakMap;const xn=6e11;class Pn extends E{constructor(e){super(e)}get timingDistribution(){return this.inner}validate(e){if(M(e)||!Array.isArray(e))return{type:w.Error,errorType:i.InvalidType,errorMessage:`Expected valid TimingDistribution object, got ${JSON.stringify(e)}`};const t=e.find((e=>e<0));return t?{type:w.Error,errorType:i.InvalidValue,errorMessage:`Expected all durations to be greater than 0, got ${t}`}:{type:w.Success}}payload(){const e=Zi(this.inner,2,8);return{values:e.values,sum:e.sum}}}class Dn extends At{constructor(e,t){super("timing_distribution",e,Pn),this.timeUnit=t,this.startTimes={},this.timerId=0}getNextTimerId(){return this.timerId++,this.timerId}start(){const e=V(),t=this.getNextTimerId();return b.isPlatformSync()?this.setStartSync(t,e):this.setStart(t,e),t}setStart(e,t){this.setStartAsync(e,t)}stopAndAccumulate(e){const t=V();b.isPlatformSync()?this.setStopAndAccumulateSync(e,t):this.setStopAndAccumulate(e,t)}setStopAndAccumulate(e,t){this.setStopAndAccumulateAsync(e,t)}cancel(e){delete this.startTimes[e]}accumulateSamples(e){b.isPlatformSync()?this.setAccumulateSamplesSync(e):this.setAccumulateSamples(e)}setAccumulateSamples(e){this.setAccumulateSamplesAsync(e)}accumulateRawSamplesNanos(e){b.isPlatformSync()?this.accumulateRawSamplesNanosSync(e):this.accumulateRawSamplesNanosAsync(e)}setStopAndAccumulateTransformFn(e){return t=>{const i=Bi(t);return new Pn([...i,e])}}setAccumulateSamplesTransformFn(e,t){return i=>{const n=Bi(i),r=[];return e.forEach((e=>{e>=0&&(0===e?e=1:e>t&&(e=t),e=Gt(e,this.timeUnit),r.push(e))})),new Pn([...n,...r])}}accumulateRawSamplesNanosTransformFn(e,t){const i=Gt(1,this.timeUnit);return n=>{const r=Bi(n),s=[];return e.forEach((e=>{e<i?e=i:e>t&&(e=t),s.push(e)})),new Pn([...r,...s])}}setStartAsync(e,t){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){return this.startTimes[e]=t,Promise.resolve()}))))}setStopAndAccumulateAsync(e,t){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return void delete this.startTimes[e];const n=this.startTimes[e];if(void 0===n)return void(yield b.errorManager.record(this,i.InvalidState,"Timing not running"));delete this.startTimes[e];let r=t-n;if(r<0)return void(yield b.errorManager.record(this,i.InvalidValue,"Timer stopped with negative duration"));const s=Gt(1,this.timeUnit),a=Gt(xn,this.timeUnit);r<s?r=s:r>a&&(yield b.errorManager.record(this,i.InvalidState,`Sample is longer than the max for a timeUnit of ${this.timeUnit} (${r} ns)`),r=a);try{yield b.metricsDatabase.transform(this,this.setStopAndAccumulateTransformFn(r))}catch(e){e instanceof S&&(yield e.recordError(this))}return Promise.resolve()}))))}setAccumulateSamplesAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;const t=Gt(xn,this.timeUnit);yield b.metricsDatabase.transform(this,this.setAccumulateSamplesTransformFn(e,t));const n=Ji(e);n>0&&(yield b.errorManager.record(this,i.InvalidValue,`Accumulated ${n} negative samples`,n));const r=qi(e,t);r>0&&(yield b.errorManager.record(this,i.InvalidOverflow,`${r} samples are longer than the maximum of ${t}`,r))}))))}accumulateRawSamplesNanosAsync(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;const t=Gt(xn,this.timeUnit);yield b.metricsDatabase.transform(this,this.accumulateRawSamplesNanosTransformFn(e,t));const n=qi(e,t);n>0&&(yield b.errorManager.record(this,i.InvalidOverflow,`${n} samples are longer than the maximum of ${t}`,n))}))))}setStartSync(e,t){this.startTimes[e]=t}setStopAndAccumulateSync(e,t){if(!this.shouldRecord(b.uploadEnabled))return void delete this.startTimes[e];const n=this.startTimes[e];if(void 0===n)return void b.errorManager.record(this,i.InvalidState,"Timing not running");delete this.startTimes[e];let r=t-n;if(r<0)return void b.errorManager.record(this,i.InvalidValue,"Timer stopped with negative duration");const s=Gt(1,this.timeUnit),a=Gt(xn,this.timeUnit);r<s?r=s:r>a&&(b.errorManager.record(this,i.InvalidState,`Sample is longer than the max for a timeUnit of ${this.timeUnit} (${r} ns)`),r=a);try{b.metricsDatabase.transform(this,this.setStopAndAccumulateTransformFn(r))}catch(e){e instanceof S&&e.recordErrorSync(this)}}setAccumulateSamplesSync(e){if(!this.shouldRecord(b.uploadEnabled))return;const t=Gt(xn,this.timeUnit);b.metricsDatabase.transform(this,this.setAccumulateSamplesTransformFn(e,t));const n=Ji(e);n>0&&b.errorManager.record(this,i.InvalidValue,`Accumulated ${n} negative samples`,n);const r=qi(e,t);r>0&&b.errorManager.record(this,i.InvalidOverflow,`${r} samples are longer than the maximum of ${t}`,r)}accumulateRawSamplesNanosSync(e){if(!this.shouldRecord(b.uploadEnabled))return;const t=Gt(xn,this.timeUnit);b.metricsDatabase.transform(this,this.accumulateRawSamplesNanosTransformFn(e,t));const n=qi(e,t);n>0&&b.errorManager.record(this,i.InvalidOverflow,`${n} samples are longer than the maximum of ${t}`,n)}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.TimingDistributionMetricType")){let t;if(yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t)return Wi(Zi(t,2,8))}}))}testGetNumRecordedErrors(e,t=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){return O("testGetNumRecordedErrors")?b.errorManager.testGetNumRecordedErrors(this,e,t):0}))}}var $n;Mn=new WeakMap;const An=8192,Rn=/^[a-zA-Z][a-zA-Z0-9-\+\.]*:(.*)$/;class Un extends E{constructor(e){super(e)}validate(e){const t=be(e);if(t.type===w.Error)return t;const n=e;return n.startsWith("data:")?{type:w.Error,errorMessage:"URL metric does not support data URLs",errorType:i.InvalidValue}:Rn.test(n)?{type:w.Success}:{type:w.Error,errorMessage:`"${n}" does not start with a valid URL scheme`,errorType:i.InvalidValue}}payload(){return this.inner}}class kn extends At{constructor(e){super("url",e,Un)}setUrl(e){b.isPlatformSync()?this.setSync(e.toString()):this.setAsync(e.toString())}setAsync(e){this.set(e)}set(e){b.dispatcher.launch((()=>n(this,void 0,void 0,(function*(){if(!this.shouldRecord(b.uploadEnabled))return;let t;t=e.length>An?yield k(this,e,An):e;try{const e=new Un(t);yield b.metricsDatabase.record(this,e)}catch(e){e instanceof S&&(yield e.recordError(this))}}))))}setSync(e){if(!this.shouldRecord(b.uploadEnabled))return;let t;t=e.length>An?N(this,e,An):e;try{const e=new Un(t);b.metricsDatabase.record(this,e)}catch(e){e instanceof S&&e.recordErrorSync(this)}}testGetValue(e=this.sendInPings[0]){return n(this,void 0,void 0,(function*(){if(O("testGetValue","core.metrics.URLMetricType")){let t;return yield b.dispatcher.testLaunch((()=>n(this,void 0,void 0,(function*(){t=yield b.metricsDatabase.getMetric(e,this)})))),t}}))}}$n=new WeakMap;const Nn=Object.assign(Object.assign({},(On=Ni,{initialize(e,t,i){Pi.setPlatform(On),Pi.initialize(e,t,i)},setUploadEnabled(e){Pi.setUploadEnabled(e)},setLogPings(e){Pi.setLogPings(e)},setDebugViewTag(e){Pi.setDebugViewTag(e)},shutdown:()=>Pi.shutdown(),setSourceTags(e){Pi.setSourceTags(e)}})),{ErrorType:i,testResetGlean:function(e,t=!0,i,r=!0){return n(this,void 0,void 0,(function*(){yield Di(r),yield function(e,t=!0,i){return n(this,void 0,void 0,(function*(){b.testing=!0,Pi.setPlatform(H),Pi.initialize(e,t,i),yield b.dispatcher.testBlockOnQueue()}))}(e,t,i)}))},_private:{PingType:class{constructor(e){vi.set(this,void 0),a(this,vi,new Si(e),"f")}submit(e){s(this,vi,"f").submit(e)}testBeforeNextSubmit(e){return n(this,void 0,void 0,(function*(){return s(this,vi,"f").testBeforeNextSubmit(e)}))}},BooleanMetricType:class{constructor(e){Oi.set(this,void 0),a(this,Oi,new Vi(e),"f")}set(e){s(this,Oi,"f").set(e)}testGetValue(e=s(this,Oi,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Oi,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,Oi,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Oi,"f").testGetNumRecordedErrors(e,t)}))}},CounterMetricType:class{constructor(e){Jt.set(this,void 0),a(this,Jt,new Kt(e),"f")}add(e){s(this,Jt,"f").add(e)}testGetValue(e=s(this,Jt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Jt,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,Jt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Jt,"f").testGetNumRecordedErrors(e,t)}))}},CustomDistributionMetricType:class{constructor(e,t,i,n,r){_i.set(this,void 0),a(this,_i,new Ki(e,t,i,n,r),"f")}accumulateSamples(e){s(this,_i,"f").accumulateSamples(e)}testGetValue(e=s(this,_i,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,_i,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,_i,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,_i,"f").testGetNumRecordedErrors(e,t)}))}},DatetimeMetricType:class{constructor(e,t){Ct.set(this,void 0),a(this,Ct,new jt(e,t),"f")}set(e){s(this,Ct,"f").set(e)}testGetValueAsString(e=s(this,Ct,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Ct,"f").testGetValueAsString(e)}))}testGetValue(e=s(this,Ct,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Ct,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,Ct,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Ct,"f").testGetNumRecordedErrors(e,t)}))}},EventMetricType:class{constructor(e,t){Xt.set(this,void 0),a(this,Xt,new Zt(e,t),"f")}record(e){s(this,Xt,"f").record(e)}testGetValue(e=s(this,Xt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Xt,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,Xt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Xt,"f").testGetNumRecordedErrors(e,t)}))}},LabeledMetricType:me,MemoryDistributionMetricType:class{constructor(e,t){en.set(this,void 0),a(this,en,new sn(e,t),"f")}accumulate(e){s(this,en,"f").accumulate(e)}accumulateSamples(e){s(this,en,"f").accumulateSamples(e)}testGetValue(e=s(this,en,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,en,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,en,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,en,"f").testGetNumRecordedErrors(e,t)}))}},QuantityMetricType:class{constructor(e){an.set(this,void 0),a(this,an,new cn(e),"f")}set(e){s(this,an,"f").set(e)}testGetValue(e=s(this,an,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,an,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,an,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,an,"f").testGetNumRecordedErrors(e,t)}))}},RateMetricType:class{constructor(e){dn.set(this,void 0),a(this,dn,new hn(e),"f")}addToNumerator(e){s(this,dn,"f").addToNumerator(e)}addToDenominator(e){s(this,dn,"f").addToDenominator(e)}testGetValue(e=s(this,dn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,dn,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,dn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,dn,"f").testGetNumRecordedErrors(e,t)}))}},StringMetricType:class{constructor(e){zt.set(this,void 0),a(this,zt,new Ft(e),"f")}set(e){s(this,zt,"f").set(e)}testGetValue(e=s(this,zt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,zt,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,zt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,zt,"f").testGetNumRecordedErrors(e,t)}))}},StringListMetricType:class{constructor(e){fn.set(this,void 0),a(this,fn,new yn(e),"f")}set(e){s(this,fn,"f").set(e)}add(e){s(this,fn,"f").add(e)}testGetValue(e=s(this,fn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,fn,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,fn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,fn,"f").testGetNumRecordedErrors(e,t)}))}},TimespanMetricType:class{constructor(e,t){En.set(this,void 0),a(this,En,new In(e,t),"f")}start(){s(this,En,"f").start()}stop(){s(this,En,"f").stop()}cancel(){s(this,En,"f").cancel()}setRawNanos(e){s(this,En,"f").setRawNanos(e)}testGetValue(e=s(this,En,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,En,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,En,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,En,"f").testGetNumRecordedErrors(e,t)}))}},TimingDistributionMetricType:class{constructor(e,t){Mn.set(this,void 0),a(this,Mn,new Dn(e,t),"f")}start(){return s(this,Mn,"f").start()}setStart(e,t){s(this,Mn,"f").setStart(e,t)}stopAndAccumulate(e){s(this,Mn,"f").stopAndAccumulate(e)}setStopAndAccumulate(e,t){s(this,Mn,"f").setStopAndAccumulate(e,t)}accumulateRawSamplesNanos(e){s(this,Mn,"f").accumulateRawSamplesNanos(e)}accumulateSamples(e){s(this,Mn,"f").accumulateSamples(e)}setAccumulateSamples(e){s(this,Mn,"f").setAccumulateSamples(e)}cancel(e){s(this,Mn,"f").cancel(e)}testGetValue(e=s(this,Mn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Mn,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,Mn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Mn,"f").testGetNumRecordedErrors(e,t)}))}},TextMetricType:class{constructor(e){vn.set(this,void 0),a(this,vn,new Sn(e),"f")}set(e){s(this,vn,"f").set(e)}testGetValue(e=s(this,vn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,vn,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,vn,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,vn,"f").testGetNumRecordedErrors(e,t)}))}},UUIDMetricType:class{constructor(e){Rt.set(this,void 0),a(this,Rt,new Nt(e),"f")}set(e){s(this,Rt,"f").set(e)}generateAndSet(){return s(this,Rt,"f").generateAndSet()}testGetValue(e=s(this,Rt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Rt,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,Rt,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,Rt,"f").testGetNumRecordedErrors(e,t)}))}},URLMetricType:class{constructor(e){$n.set(this,void 0),a(this,$n,new kn(e),"f")}set(e){s(this,$n,"f").set(e)}setUrl(e){s(this,$n,"f").setUrl(e)}testGetValue(e=s(this,$n,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,$n,"f").testGetValue(e)}))}testGetNumRecordedErrors(e,t=s(this,$n,"f").sendInPings[0]){return n(this,void 0,void 0,(function*(){return s(this,$n,"f").testGetNumRecordedErrors(e,t)}))}}}});var On})(),Glean=t})();